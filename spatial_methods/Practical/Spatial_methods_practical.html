
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The dataset &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Practical introduction
  </a>
 </li>
</ul>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html">
   Practical One: GIS data and plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#converting-between-vector-and-raster-data-types">
   Converting between vector and raster data types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#using-data-in-files">
   Using data in files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#overlaying-raster-and-vector-data">
   Overlaying raster and vector data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#spatial-joins-and-raster-data-extraction">
   Spatial joins and raster data extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#mini-projects">
   Mini projects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../practical_1/practical_1.html#appendix">
   Appendix
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/spatial_methods/Practical/Spatial_methods_practical.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   The dataset
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#statistical-models-of-the-data">
   Statistical models of the data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#installing-packages">
   Installing packages
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-the-data-into-r">
   Loading the data into R
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exploring-the-data">
   Exploring the data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#correlations-and-spatial-data">
   Correlations and spatial data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#measuring-spatial-autocorrelation">
   Measuring spatial autocorrelation
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#autoregressive-models">
   Autoregressive models
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#correlograms">
   Correlograms
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p>This practical looks at some of the problems of fitting statistical models to spatial data, using the statistical software R.</p>
<div class="section" id="the-dataset">
<h1>The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this headline">¶</a></h1>
<p>This practical will use some data taken from a paper that looked at trying to predict what limits species ranges:</p>
<p>McInnes, L., Purvis, A., &amp; Orme, C. D. L. (2009). Where do species’ geographic ranges stop and why? Landscape impermeability and the Afrotropical avifauna. Proceedings of the Royal Society Series B - Biological Sciences, 276(1670), 3063-3070. [http://doi.org/10.1098/rspb.2009.0656]</p>
<p>We won’t actually be looking at range edges but we’re going to use four variables taken from the data used in this paper. The data is all saved as GeoTIFF files, so we’re starting with raster data. The files cover the Afrotropics and are all  projected in the Behrmann equal area projection with a resolution of 96.268 km. That might seem like an odd number: it is chosen to make the resolution of the data comparable to a degree longitude at <span class="math notranslate nohighlight">\(30^\circ\)</span> N. Unlike a one degree resolution grid, however, these grid cells all cover an equal area on the ground (<span class="math notranslate nohighlight">\(96.268 \times 96.268 = 9309.6 \text{km}^2\)</span>, roughly the land area of Cyprus).</p>
<p>The variables for each grid cell are:</p>
<ul class="simple">
<li><p>the avian species richness across the Afrotropics,</p></li>
<li><p>the mean elevation,</p></li>
<li><p>the average annual temperature, and</p></li>
<li><p>the average annual actual evapotranspiration.</p></li>
</ul>
<div style='background-color:lightgreen'>
* As a first step, start up QGIS and load in the four TIFF files and the cntry98 shapefile and make sure that you are looking at the data in your project using the Behrmann projection. Like the MODIS sinusoidal projection, this isn't one of the standard choices so you might need to look in the  user generated projection definitions.
* Take a look at the variables and think about the patterns in each. Where is each highest and why? Are there any areas where they show similar patterns?
</div>
</div>
<div class="section" id="statistical-models-of-the-data">
<h1>Statistical models of the data<a class="headerlink" href="#statistical-models-of-the-data" title="Permalink to this headline">¶</a></h1>
<p>In order to use statistics on the data, we are going to use the R programming.</p>
<ul class="simple">
<li><p>Do <strong>not</strong> panic.</p></li>
</ul>
<p>I know that not all of you will have used R. It is not an easy program: telling R to do something usually involves typing in code, not choosing options from menus. The intention in this practical is to show some options that are available for spatial models in R, not to learn R, so you can just copy and paste the code. The main thing is to think about what the options are available, not in learning how to do it all in one afternoon!</p>
</div>
<div class="section" id="installing-packages">
<h1>Installing packages<a class="headerlink" href="#installing-packages" title="Permalink to this headline">¶</a></h1>
<p>You may need to install some R packages to run this pracitical. If you are using your own laptop or a Linux laptop, then you should be able to just install them using:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;package_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On the College computers, you should have them all but we are missing one that we will need. So, if you are on a College Windows computer, then copy in the following code, which will create a temporary copy of the <code class="docutils literal notranslate"><span class="pre">ncf</span></code> package for us to use.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;ncf&#39;</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="s">&quot;C:/Temp&quot;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ncf</span><span class="p">,</span> <span class="n">lib.loc</span><span class="o">=</span><span class="s">&#39;C:/Temp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="loading-the-data-into-r">
<h1>Loading the data into R<a class="headerlink" href="#loading-the-data-into-r" title="Permalink to this headline">¶</a></h1>
<p>One of the core ideas of data handling in R is the <strong>data frame</strong>. This is a data table where each column holds the values of a single variable and a row shows the values of each variable for a particular observation. It is superficially pretty similar to a spreadsheet in Excel except that it is a lot more picky about only having one kind of data in a column!</p>
<p>We need to get our raster data into R and into a data frame.</p>
<div style='background-color:lightgreen'>
* First, you will need to change the working directory to the practical folder. The 'working directory' is the folder that R will look in when you give it a file name, so has to be set to allow use to read the data. There will be a menu option to choose it or you can use `setwd('path/to/the/practical')` if you're feeling confident!.
<ul class="simple">
<li><p>Next, you will need to copy in the following code. The coloured lines starting with the <code class="docutils literal notranslate"><span class="pre">#</span></code> symbol are comments, annotating the R code, which you can just copy straight across.</p></li>
</ul>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the raster library to handle GIS data files</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Loading required package: sp</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the four variables from their TIFF files</span>
<span class="n">rich</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/avian_richness.tif&#39;</span><span class="p">)</span>
<span class="n">aet</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/mean_aet.tif&#39;</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/mean_temp.tif&#39;</span><span class="p">)</span>
<span class="n">elev</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/elev.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>What that just did is to load each raster into R and store it in an R <strong>object</strong>: that is basically just a slot of memory in R that can save data and results and which we can refer to by name. We can look at one in more detail by typing its name - note that in this example code and other blocks below,  information that R prints on the screen is shown as lines starting with <code class="docutils literal notranslate"><span class="pre">##</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># type in the raster object name to view some</span>
<span class="c1"># details and check it loaded!</span>
<span class="n">rich</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## class       : RasterLayer </span>
<span class="c1">## dimensions  : 75, 78, 5850  (nrow, ncol, ncell)</span>
<span class="c1">## resolution  : 96.48627, 96.48627  (x, y)</span>
<span class="c1">## extent      : -1736.753, 5789.176, -4245.396, 2991.074  (xmin, xmax, ymin, ymax)</span>
<span class="c1">## coord. ref. : +proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +units=km +no_defs +ellps=WGS84 +towgs84=0,0,0 </span>
<span class="c1">## data source : /Users/dorme/Teaching/MSc_GIS_2016/SpatialMethods/Practical/data/avian_richness.tif </span>
<span class="c1">## names       : avian_richness </span>
<span class="c1">## values      : 10, 667  (min, max)</span>
</pre></div>
</div>
<div style='background-color:lightgreen'>
* Repeat this with each of the new raster objects: there is a lot of GIS information which hopefully now is less obscure and then at the bottom is the range of the values in each raster.
</div>
<p>We can use R to explore this data more. First we’ll use the <code class="docutils literal notranslate"><span class="pre">hist()</span></code> function to plot the distribution of the values in each variable, not just look at the minimum and maximum.</p>
<div style='background-color:lightgreen'>
* Copy and paste in the code below. The first command allows us to put four plots in a single figure.
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the figure area into a two by two layout</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># plot a histogram of the values in each raster, setting nice &#39;main&#39; titles</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Avian species richness&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">aet</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean AET&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean annual temperature&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Elevation&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk raster_hist" src="../../_images/raster_hist-1.pdf" /></p>
<p>We can also look at the rasters as spatial objects by plotting them. In most cases, QGIS is the simpler way to display and explore maps, but we can do it in R too. In this case, the <code class="docutils literal notranslate"><span class="pre">plot()</span></code> command knows that the rasters are spatial data, so displays them as maps with a scale bar.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the figure area into a two by two layout</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># plot a map of the values in each raster, setting nice &#39;main&#39; titles</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Avian species richness&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">aet</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean AET&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean annual temperature&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Elevation&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk raster_plot" src="../../_images/raster_plot-1.pdf" /></p>
<p>Before we do anything further statistical, look at those maps. One key skills in being a good scientist and statistician is in looking at data and a model and saying:</p>
<p><em>$?&amp;!, that doesn’t make any sense, I must have done it wrong.</em></p>
<p>It is <strong>really important</strong> to think beforehand about the kinds of predictions we might expect from our data, so:</p>
<div style='background-color:lightgreen'>
* What are the conditions that predict high species richness? There may not be a single set of conditions, but what are the general features of diverse areas?
</div>
<p>Now, we have the data as rasters - 2 dimensional grids of values - but we need to get our data frame. We’ll need to use two commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stack()</span></code> allows us to superimpose the four rasters into a single object. Note that this only works because all of these rasters have the same projection, extent and resolution. In your own use, you would need to use GIS to set up your data so it can be stacked like this.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">as()</span></code> allows us to convert an R object from one format to another. There are a set of predefined conversion recipes and one takes a stack of rasters and turns it into something called a SpatialPixelDataFrame, which is just our values in a table but with a record of their spatial position.</p></li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">stack</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">aet</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## class       : RasterStack </span>
<span class="c1">## dimensions  : 75, 78, 5850, 4  (nrow, ncol, ncell, nlayers)</span>
<span class="c1">## resolution  : 96.48627, 96.48627  (x, y)</span>
<span class="c1">## extent      : -1736.753, 5789.176, -4245.396, 2991.074  (xmin, xmax, ymin, ymax)</span>
<span class="c1">## coord. ref. : +proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +units=km +no_defs +ellps=WGS84 +towgs84=0,0,0 </span>
<span class="c1">## names       : avian_richness,  mean_aet,      elev, mean_temp </span>
<span class="c1">## min values  :        10.0000,   32.0600,    1.0000,   10.5246 </span>
<span class="c1">## max values  :       667.0000, 1552.6500, 2750.2800,   30.3667</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_df</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;SpatialPixelsDataFrame&#39;</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Object of class SpatialPixelsDataFrame</span>
<span class="c1">## Coordinates:</span>
<span class="c1">##         min      max</span>
<span class="c1">## x -1736.753 5789.176</span>
<span class="c1">## y -4245.396 2991.074</span>
<span class="c1">## Is projected: TRUE </span>
<span class="c1">## proj4string :</span>
<span class="c1">## [+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0</span>
<span class="c1">## +datum=WGS84 +units=km +no_defs +ellps=WGS84</span>
<span class="c1">## +towgs84=0,0,0]</span>
<span class="c1">## Number of points: 2484</span>
<span class="c1">## Grid attributes:</span>
<span class="c1">##    cellcentre.offset cellsize cells.dim</span>
<span class="c1">## s1         -1688.510 96.48627        78</span>
<span class="c1">## s2         -4197.153 96.48627        75</span>
<span class="c1">## Data attributes:</span>
<span class="c1">##  avian_richness     mean_aet            elev       </span>
<span class="c1">##  Min.   : 10.0   Min.   :  32.06   Min.   :   1.0  </span>
<span class="c1">##  1st Qu.:202.0   1st Qu.: 439.70   1st Qu.: 317.7  </span>
<span class="c1">##  Median :269.5   Median : 754.59   Median : 548.8  </span>
<span class="c1">##  Mean   :268.4   Mean   : 732.07   Mean   : 672.0  </span>
<span class="c1">##  3rd Qu.:341.0   3rd Qu.: 996.60   3rd Qu.:1023.2  </span>
<span class="c1">##  Max.   :667.0   Max.   :1552.65   Max.   :2750.3  </span>
<span class="c1">##    mean_temp    </span>
<span class="c1">##  Min.   :10.52  </span>
<span class="c1">##  1st Qu.:21.83  </span>
<span class="c1">##  Median :24.71  </span>
<span class="c1">##  Mean   :24.25  </span>
<span class="c1">##  3rd Qu.:27.15  </span>
<span class="c1">##  Max.   :30.37</span>
</pre></div>
</div>
<p>Note that the names of the variables in the data frame have been set from the original TIFF filenames!</p>
</div>
<div class="section" id="exploring-the-data">
<h1>Exploring the data<a class="headerlink" href="#exploring-the-data" title="Permalink to this headline">¶</a></h1>
<p>So, where does that get us? We now have a new data structure that know where it is in space and has matched up  different variables across cells. We can still plot the data as a map by making use of the <code class="docutils literal notranslate"><span class="pre">spplot()</span></code> function, which is a specific plot function for making spatial plots of our new data structure:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot a map of the data in data_df, chosing the column</span>
<span class="c1"># holding the richness data, changing the default colours and</span>
<span class="c1"># showing the geographic scales</span>
<span class="nf">spplot</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">zcol</span> <span class="o">=</span> <span class="s">&quot;avian_richness&quot;</span><span class="p">,</span> <span class="n">col.regions</span> <span class="o">=</span> <span class="nf">heat.colors</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> 
    <span class="n">scales</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">draw</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="plot of chunk spplot" src="../../_images/spplot-1.pdf" /></p>
<p>But we can also plot the variables against each other, by treating the new object as a data frame:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create three figures in a single panel</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>
<span class="c1"># Now plot richness as a function of each environmental</span>
<span class="c1"># variable</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_temp</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">elev</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk plot_vars" src="../../_images/plot_vars-1.pdf" /></p>
</div>
<div class="section" id="correlations-and-spatial-data">
<h1>Correlations and spatial data<a class="headerlink" href="#correlations-and-spatial-data" title="Permalink to this headline">¶</a></h1>
<p>A <strong>correlation coefficient</strong> is a standardised measure between -1 and 1 showing how much observations of two variables tend to co-vary. For a positive correlation, both variables tend to have high values in the same locations and low values in the same locations. Negative correlations show the opposite. Once you’ve calculated a correlation, you need to assess how strong that correlation is <em>given the amount of data you have</em>: it is easy to get large <span class="math notranslate nohighlight">\(r\)</span> values in small datasets by chance.</p>
<p>However, correlation coefficients assume that the data points are independent and this is not true for spatial data. Nearby data points tend to be similar: if you are in a warm location, surrounding areas will also tend to be warm. One relatively simple way of removing this non-independence is to calculate the significance of tests as if you had fewer data points.</p>
<p>We will use this approach to  compare standard measures of correlation to spatially corrected ones. We need to load a new set of functions that implement a modification to the correlation test that accounts for spatial similarity, described in (this paper)[https://jstor.org/stable/2532039]. The modified test does not change the correlation statistic itself but calculates a new effective sample size (ess) that is then used to calculate the test significance: <span class="math notranslate nohighlight">\(r\)</span> will not change, but the degrees of freedom, <span class="math notranslate nohighlight">\(t\)</span> statistic and the <span class="math notranslate nohighlight">\(p\)</span> value will change.</p>
<div style='background-color:lightgreen'>
* The `source()` function loads the new test and then the following two commands run the standard correlation test and the spatially corrected one.
* The code produces these results for the correlation between avian species richness and mean AET: run this and then modify it to see how it changes the results for mean temperature and elevation. 
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the new function: clifford.test()</span>
<span class="nf">source</span><span class="p">(</span><span class="s">&quot;clifford.test.R&quot;</span><span class="p">)</span>
<span class="c1"># run the standard test</span>
<span class="nf">cor.test</span><span class="p">(</span><span class="o">~</span><span class="n">avian_richness</span> <span class="o">+</span> <span class="n">mean_aet</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## </span>
<span class="c1">## 	Pearson&#39;s product-moment correlation</span>
<span class="c1">## </span>
<span class="c1">## data:  avian_richness and mean_aet</span>
<span class="c1">## t = 31.115, df = 2482, p-value &lt; 2.2e-16</span>
<span class="c1">## alternative hypothesis: true correlation is not equal to 0</span>
<span class="c1">## 95 percent confidence interval:</span>
<span class="c1">##  0.5008302 0.5574404</span>
<span class="c1">## sample estimates:</span>
<span class="c1">##      cor </span>
<span class="c1">## 0.529725</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the modified test. It needs matrices (grids) of the two</span>
<span class="c1"># variables to calculate the corrections.</span>
<span class="nf">clifford.test</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">rich</span><span class="p">),</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">aet</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## </span>
<span class="c1">## Correlation test accounting for autocorrelation (Clifford et al., 1989)</span>
<span class="c1">## </span>
<span class="c1">## Data - Matrix A: as.matrix(rich) </span>
<span class="c1">##      - Matrix B: as.matrix(aet) </span>
<span class="c1">## </span>
<span class="c1">##  rpearson    n         ncc    var.xy      var.r      ess</span>
<span class="c1">##  0.529725 2484 7.14048e+14 115724216 0.07316509 14.66772</span>
<span class="c1">##         w       t           p</span>
<span class="c1">##  1.958387 2.74931 0.008446161</span>
</pre></div>
</div>
</div>
<div class="section" id="measuring-spatial-autocorrelation">
<h1>Measuring spatial autocorrelation<a class="headerlink" href="#measuring-spatial-autocorrelation" title="Permalink to this headline">¶</a></h1>
<p>There are a number of statistics that quantify the level of spatial autocorrelation. We will be looking at Moran’s I statistic, but others exist, such as Geary’s C statistic, so look out for these in any modelling papers. Moran’s I takes values between -1 and 1, with the central value of 0 showing that there is no spatial autocorrelation. Values close to -1 show strong negative autocorrelation, which is the unusual case that nearby cells have unexpectedly <strong>different</strong> values and values close to 1 show that nearby cells have unexpectedly <strong>similar</strong> values.</p>
<p>Spatial autocorrelation is all about saying how similar nearby points are to each other, so we first need to define ‘nearby’. There are two main ways of doing this - you can choose the <span class="math notranslate nohighlight">\(k\)</span> nearest neighbours of a point or you can choose all points within a particular distance. We will take this second approach using the <code class="docutils literal notranslate"><span class="pre">dnearneigh()</span></code> function, but for reference the function <code class="docutils literal notranslate"><span class="pre">knearneigh()</span></code> allows you to do the first one.</p>
<p>If we use a distance cutoff of 150 km then all cells that share an edge or a corner with a given cell will be considered its neighbour. Using chess as an analogy, this is sometimes called Queen’s move connections (although it is actually like a King’s move!) and the alternative where only cells sharing an edge are neighbours is called Rook’s move. In the code below, we also have to set <code class="docutils literal notranslate"><span class="pre">zero.policy=TRUE</span></code>: this allows the code to ignore some checks on isolated points that have no neighbours within 150 km.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the spatial dependence analysis package</span>
<span class="nf">library</span><span class="p">(</span><span class="n">spdep</span><span class="p">)</span>
<span class="c1"># All cells with centres closer than 150km are neighbours of</span>
<span class="c1"># a cell</span>
<span class="n">neighbours</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="m">150</span><span class="p">)</span>
<span class="c1"># convert that to a weighted list of neighbours</span>
<span class="n">neighbours.lw</span> <span class="o">&lt;-</span> <span class="nf">nb2listw</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">zero.policy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># global Moran&#39;s I for avian richness</span>
<span class="n">rich.moran</span> <span class="o">&lt;-</span> <span class="nf">moran.test</span><span class="p">(</span><span class="n">data_df</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">neighbours.lw</span><span class="p">,</span> 
    <span class="n">zero.policy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="n">rich.moran</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## </span>
<span class="c1">## 	Moran I test under randomisation</span>
<span class="c1">## </span>
<span class="c1">## data:  data_df$avian_richness  </span>
<span class="c1">## weights: neighbours.lw  </span>
<span class="c1">## </span>
<span class="c1">## Moran I statistic standard deviate = 88.419, p-value</span>
<span class="c1">## &lt; 2.2e-16</span>
<span class="c1">## alternative hypothesis: greater</span>
<span class="c1">## sample estimates:</span>
<span class="c1">## Moran I statistic       Expectation          Variance </span>
<span class="c1">##      0.9264783441     -0.0004032258      0.0001098905</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">moran.test()</span></code> function gives a single value representing the overall level of spatial autocorrelation in a variable, but we can also look at local indicators of spatial autocorrelation (LISA), which can reveal areas of stronger or weaker similarity. These calculate a similar statistic but only within a window around each cell and report back the calculated value for each cell, which we can then map. Local Moran’s I is still centred on zero for no spatial autocorrelation but values are not constrained between -1 and 1.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the same neighbour definition to get local</span>
<span class="c1"># autocorrelation</span>
<span class="n">rich.lisa</span> <span class="o">&lt;-</span> <span class="nf">localmoran</span><span class="p">(</span><span class="n">data_df</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">neighbours.lw</span><span class="p">,</span> 
    <span class="n">zero.policy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># The rich.lisa results contain several variables in columns:</span>
<span class="c1"># we add one to our dataframe to plot it</span>
<span class="n">data_df</span><span class="o">$</span><span class="n">rich_lisa</span> <span class="o">&lt;-</span> <span class="n">rich.lisa</span><span class="p">[,</span> <span class="m">1</span><span class="p">]</span>
<span class="c1"># plot the values.</span>
<span class="nf">spplot</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">zcol</span> <span class="o">=</span> <span class="s">&quot;rich_lisa&quot;</span><span class="p">,</span> <span class="n">col.regions</span> <span class="o">=</span> <span class="nf">heat.colors</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> 
    <span class="n">scales</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">draw</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="plot of chunk lisa" src="../../_images/lisa-1.pdf" /></p>
<div style='background-color:lightgreen'>
* As we might predict, avian richness shows strong positive spatial autocorrelation, which seems to be particularly strong in the mountains around Lake Victoria. Try these measures out on the other variables!
</div>
</div>
<div class="section" id="autoregressive-models">
<h1>Autoregressive models<a class="headerlink" href="#autoregressive-models" title="Permalink to this headline">¶</a></h1>
<p>Our definition of a set of neighbours allows us to fit a spatial autoregressive (SAR) model. This is a statistical model that predicts the value of a response variable in a cell using the predictor variables and values of the response variable in neighbouring cells. This is why they are called autoregressive models: they fit the response variable partly as a response to itself.</p>
<p>They come in many different possible forms. This is a great paper explaining some of the different forms with some great appendices including example R code:</p>
<p>Kissling, W. D., &amp; Carl, G. (2008). Spatial autocorrelation and the selection of simultaneous autoregressive models. Global Ecology and Biogeography, 17(1), 59–71.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a simple linear model</span>
<span class="n">simple_model</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">elev</span> <span class="o">+</span> <span class="n">mean_temp</span><span class="p">,</span> 
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## </span>
<span class="c1">## Call:</span>
<span class="c1">## lm(formula = avian_richness ~ mean_aet + elev + mean_temp, data = data_df)</span>
<span class="c1">## </span>
<span class="c1">## Residuals:</span>
<span class="c1">##     Min      1Q  Median      3Q     Max </span>
<span class="c1">## -354.09  -53.25   -0.93   52.64  325.58 </span>
<span class="c1">## </span>
<span class="c1">## Coefficients:</span>
<span class="c1">##               Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="c1">## (Intercept) 189.452772  21.328794   8.882  &lt; 2e-16 ***</span>
<span class="c1">## mean_aet      0.176412   0.004724  37.342  &lt; 2e-16 ***</span>
<span class="c1">## elev          0.076027   0.005490  13.849  &lt; 2e-16 ***</span>
<span class="c1">## mean_temp    -4.178441   0.722002  -5.787 8.05e-09 ***</span>
<span class="c1">## ---</span>
<span class="c1">## Signif. codes:  </span>
<span class="c1">## 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
<span class="c1">## </span>
<span class="c1">## Residual standard error: 82.4 on 2480 degrees of freedom</span>
<span class="c1">## Multiple R-squared:  0.4554,	Adjusted R-squared:  0.4548 </span>
<span class="c1">## F-statistic: 691.4 on 3 and 2480 DF,  p-value: &lt; 2.2e-16</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a spatial autoregressive model: this is much slower and</span>
<span class="c1"># can take minutes to calculate</span>
<span class="n">sar_model</span> <span class="o">&lt;-</span> <span class="nf">errorsarlm</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">elev</span> <span class="o">+</span> <span class="n">mean_temp</span><span class="p">,</span> 
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">,</span> <span class="n">listw</span> <span class="o">=</span> <span class="n">neighbours.lw</span><span class="p">,</span> <span class="n">zero.policy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## </span>
<span class="c1">## Call:</span>
<span class="c1">## errorsarlm(formula = avian_richness ~ mean_aet + elev + mean_temp, </span>
<span class="c1">##     data = data_df, listw = neighbours.lw, zero.policy = TRUE)</span>
<span class="c1">## </span>
<span class="c1">## Residuals:</span>
<span class="c1">##         Min          1Q      Median          3Q         Max </span>
<span class="c1">## -218.359135   -8.991092   -0.054733    9.643101  109.813234 </span>
<span class="c1">## </span>
<span class="c1">## Type: error </span>
<span class="c1">## Regions with no neighbours included:</span>
<span class="c1">##  1311 1817 2204 </span>
<span class="c1">## Coefficients: (asymptotic standard errors) </span>
<span class="c1">##                Estimate  Std. Error z value  Pr(&gt;|z|)</span>
<span class="c1">## (Intercept) -1.2964e+02  3.3814e+01 -3.8340 0.0001261</span>
<span class="c1">## mean_aet     5.6957e-02  6.9750e-03  8.1659 2.220e-16</span>
<span class="c1">## elev         4.8364e-02  6.7019e-03  7.2165 5.336e-13</span>
<span class="c1">## mean_temp    3.1011e+00  1.2642e+00  2.4530 0.0141688</span>
<span class="c1">## </span>
<span class="c1">## Lambda: 0.99573, LR test value: 6522.3, p-value: &lt; 2.22e-16</span>
<span class="c1">## Asymptotic standard error: 0.0011623</span>
<span class="c1">##     z-value: 856.7, p-value: &lt; 2.22e-16</span>
<span class="c1">## Wald statistic: 733940, p-value: &lt; 2.22e-16</span>
<span class="c1">## </span>
<span class="c1">## Log likelihood: -11219.94 for error model</span>
<span class="c1">## ML residual variance (sigma squared): 362.3, (sigma: 19.034)</span>
<span class="c1">## Number of observations: 2484 </span>
<span class="c1">## Number of parameters estimated: 6 </span>
<span class="c1">## AIC: 22452, (AIC for lm: 28972)</span>
</pre></div>
</div>
<p>Lets look at the <strong>predictions</strong> of those models. We can extract the predicted values for each point and put them into our spatial data frame and then map them.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the predictions from the model into the spatial</span>
<span class="c1"># data frame</span>
<span class="n">data_df</span><span class="o">$</span><span class="n">simple_fit</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
<span class="n">data_df</span><span class="o">$</span><span class="n">sar_fit</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>
<span class="c1"># Compare those two predictions with the data</span>
<span class="nf">spplot</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;avian_richness&quot;</span><span class="p">,</span> <span class="s">&quot;simple_fit&quot;</span><span class="p">,</span> <span class="s">&quot;sar_fit&quot;</span><span class="p">),</span> 
    <span class="n">col.regions</span> <span class="o">=</span> <span class="nf">heat.colors</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> <span class="n">scales</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">draw</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="plot of chunk model_pred" src="../../_images/model_pred-1.pdf" /></p>
<p>We can also look at the <strong>residuals</strong> of those models -  the differences between the prediction and the actual values - to highlight where the models aren’t working well. We’ll manipulate the colours so negative residuals are blue and positive residuals are red.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the residuals from the model into the spatial data</span>
<span class="c1"># frame</span>
<span class="n">data_df</span><span class="o">$</span><span class="n">simple_resid</span> <span class="o">&lt;-</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
<span class="n">data_df</span><span class="o">$</span><span class="n">sar_resid</span> <span class="o">&lt;-</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>
<span class="c1"># Create a 21 colour ramp from blue to red, centred on zero</span>
<span class="n">colPal</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;cornflowerblue&quot;</span><span class="p">,</span> <span class="s">&quot;grey&quot;</span><span class="p">,</span> <span class="s">&quot;firebrick&quot;</span><span class="p">))</span>
<span class="n">colours</span> <span class="o">&lt;-</span> <span class="nf">colPal</span><span class="p">(</span><span class="m">21</span><span class="p">)</span>
<span class="n">breaks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-600</span><span class="p">,</span> <span class="m">600</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="m">21</span><span class="p">)</span>
<span class="c1"># plot the residuals side by side</span>
<span class="nf">spplot</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;simple_resid&quot;</span><span class="p">,</span> <span class="s">&quot;sar_resid&quot;</span><span class="p">),</span> <span class="n">col.regions</span> <span class="o">=</span> <span class="n">colours</span><span class="p">,</span> 
    <span class="n">at</span> <span class="o">=</span> <span class="n">breaks</span><span class="p">,</span> <span class="n">scales</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">draw</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="plot of chunk model_resid" src="../../_images/model_resid-1.pdf" /></p>
</div>
<div class="section" id="correlograms">
<h1>Correlograms<a class="headerlink" href="#correlograms" title="Permalink to this headline">¶</a></h1>
<p>Correlograms are another way of visualising spatial autocorrelation. They show how the correlation within a variable changes as the distance between pairs of points being compared increases. To show this, we need the coordinates of the spatial data and the values of a variable at each point.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install a missing library to calculate correlograms</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ncf</span><span class="p">)</span>
<span class="c1"># extract the X and Y coordinates</span>
<span class="n">data_xy</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">coordinates</span><span class="p">(</span><span class="n">data_df</span><span class="p">))</span>
<span class="c1"># calculate a correlogram for avian richness: a slow process!</span>
<span class="n">rich.correlog</span> <span class="o">&lt;-</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">data_xy</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> <span class="n">data_xy</span><span class="o">$</span><span class="n">y</span><span class="p">,</span> <span class="n">data_df</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> 
    <span class="n">increment</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">resamp</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">rich.correlog</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk correlogram" src="../../_images/correlogram-1.pdf" /></p>
<p>To explain that a bit further: we take a focal point and then make pairs of the value of that point and all other points. These pairs are assigned to bins based on how far apart the points are: the <em>increment</em> is the width of those bins. Once we’ve done this for all points - yes, that is a lot of pairs! - we calculate the correlations between the sets of pairs in each bin. Each bin has a mean distance among the points in that class.</p>
<p>We can get the significance of the correlations at each distance by resampling the data, but it is a very slow process, which is why the correlograms here have been set not to do any resampling (<code class="docutils literal notranslate"><span class="pre">resamp=0</span></code>).</p>
<p>We can get more control on that by creating a data frame. First, we can see that the number of pairs in a class drops off dramatically at large distances: that upswing on the right is based on few pairs, so we can generally ignore it and look at just shorter distances.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span>
<span class="c1"># convert three key variables into a data frame</span>
<span class="n">rich.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">rich.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
<span class="c1"># plot the size of the distance bins</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">n</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">rich.correlog</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;o&quot;</span><span class="p">)</span>
<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">rich.correlog</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> 
    <span class="n">subset</span> <span class="o">=</span> <span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add a horizontal zero correlation line</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk correlogram_control" src="../../_images/correlogram_control-1.pdf" /></p>
<p>One key use of correlograms is to assess how well models have controlled for spatial autocorrelation by looking at the correlation in the residuals. We can compare our two models like this and see how much better the SAR is at controlling for the autocorrelation in the data.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate correlograms for the residuals in the two models</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">data_xy</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> <span class="n">data_xy</span><span class="o">$</span><span class="n">y</span><span class="p">,</span> <span class="n">data_df</span><span class="o">$</span><span class="n">simple_resid</span><span class="p">,</span> 
    <span class="n">increment</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">resamp</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
<span class="n">sar.correlog</span> <span class="o">&lt;-</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">data_xy</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> <span class="n">data_xy</span><span class="o">$</span><span class="n">y</span><span class="p">,</span> <span class="n">data_df</span><span class="o">$</span><span class="n">sar_resid</span><span class="p">,</span> 
    <span class="n">increment</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">resamp</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
<span class="c1"># Convert those to make them easier to plot</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">simple.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
<span class="n">sar.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">sar.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>

<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">simple.correlog</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> 
    <span class="n">subset</span> <span class="o">=</span> <span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add the data for the SAR model to compare them</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sar.correlog</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> 
    <span class="n">subset</span> <span class="o">=</span> <span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>

<span class="c1"># add a horizontal zero correlation line</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="plot of chunk correlogram_models" src="../../_images/correlogram_models-1.pdf" /></p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./spatial_methods/Practical"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>