
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Practical One: GIS data and plotting &#8212; GIS and Spatial Methods in R</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Practical Two: Species Distribution Modelling" href="../practical_2/practical_2.html" />
    <link rel="prev" title="Introduction to the practicals" href="../intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">GIS and Spatial Methods in R</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction to the practicals
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Practical One: GIS data and plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_2/practical_2.html">
   Practical Two: Species Distribution Modelling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_3/practical_3.html">
   Practical Three: Spatial modelling in R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_4/LEC_week.html">
   Landscape Ecology and Conservation
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/practical_1/practical_1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/practical_1/practical_1.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/practical_1/practical_1.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#required-packages">
   Required packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vector-data">
   Vector data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-vectors-from-coordinates">
     Making vectors from coordinates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-vector-points-from-a-dataframe">
     Making vector points from a dataframe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vector-geometry-operations">
     Vector geometry operations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#features-and-geometries">
     Features and geometries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vector-data-and-attributes">
     Vector data and attributes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-attributes">
     Spatial attributes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plotting-sf-objects">
     Plotting
     <code class="docutils literal notranslate">
      <span class="pre">
       sf
      </span>
     </code>
     objects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reprojecting-vector-data">
     Reprojecting vector data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#proj4-strings">
       Proj4 strings
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#degrees-are-not-constant">
       Degrees are not constant
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rasters">
   Rasters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-raster">
     Creating a raster
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-raster-resolution">
     Changing raster resolution
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#aggregating-rasters">
     Aggregating rasters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disaggregating-rasters">
     Disaggregating rasters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resampling">
     Resampling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reprojecting-a-raster">
     Reprojecting a raster
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#converting-between-vector-and-raster-data-types">
   Converting between vector and raster data types
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vector-to-raster">
     Vector to raster
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#raster-to-vector">
     Raster to vector
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-data-in-files">
   Using data in files
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving-vector-data">
     Saving vector data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving-raster-data">
     Saving raster data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-vector-data">
     Loading Vector data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-xy-data">
     Loading XY data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-raster-data">
     Loading Raster data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#raster-stacks">
     Raster Stacks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overlaying-raster-and-vector-data">
   Overlaying raster and vector data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cropping-data">
     Cropping data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spatial-joins-and-raster-data-extraction">
   Spatial joins and raster data extraction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-joining">
     Spatial joining
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extracting-data-from-rasters">
     Extracting data from Rasters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#raster-cell-statistics-and-locations">
     Raster cell statistics and locations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-extract-function">
     The extract function
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mini-projects">
   Mini projects
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#precipitation-transect-for-new-guinea">
     Precipitation transect for  New Guinea
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fishing-pressure-in-fiji">
     Fishing pressure in Fiji
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#loading-the-data">
       Loading the data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create-the-cost-surface">
       Create the cost surface
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#finding-launch-points">
       Finding launch points
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#find-distances">
       Find distances
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assign-villages-to-sites">
       Assign villages to sites
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-ggplot-to-make-maps">
   Using ggplot to make maps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#colour-palettes">
   Colour palettes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#viridis">
     Viridis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#brewer">
     Brewer
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell tag_remove-input docutils container">
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="practical-one-gis-data-and-plotting">
<h1>Practical One: GIS data and plotting<a class="headerlink" href="#practical-one-gis-data-and-plotting" title="Permalink to this headline">¶</a></h1>
<div class="section" id="required-packages">
<h2>Required packages<a class="headerlink" href="#required-packages" title="Permalink to this headline">¶</a></h2>
<p>There are loads of R packages that can load, manipulate and plot GIS data and we will be using several in this practical. In the last few years, the R spatial  data community has been working on bringing together most of the core GIS functionality into a few core packages. We will focus on using these up-to-date central packages, but there will be some occasions where we need to use older packages.</p>
<p>This quite a long list of packages - we’ve shown what each one does. If you are working on your own machine, you will need to install these packages using the code below, but they are pre-installed in the RStudio Cloud Projects.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;raster&#39;</span><span class="p">)</span> <span class="c1"># Core raster GIS data package</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;sf&#39;</span><span class="p">)</span> <span class="c1"># Core vector GIS data package</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;sp&#39;</span><span class="p">)</span> <span class="c1"># Another core vector GIS package</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;rgeos&#39;</span><span class="p">)</span> <span class="c1"># Extends vector data functionality</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;rgdal&#39;</span><span class="p">)</span> <span class="c1"># Interface to the Geospatial Data Abstraction Library</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;lwgeom&#39;</span><span class="p">)</span> <span class="c1"># Extends vector data functionality</span>
</pre></div>
</div>
<p>To load the packages:</p>
<div class="cell tag_remove-stderr docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>You will see a whole load of package loading messages about GDAL, GEOS, PROJ which are not shown here. Don’t worry about this - they are not errors, just R linking to some key open source GIS toolkits.</p>
</div>
<div class="section" id="vector-data">
<h2>Vector data<a class="headerlink" href="#vector-data" title="Permalink to this headline">¶</a></h2>
<p>We will mostly be using the more recent <code class="docutils literal notranslate"><span class="pre">sf</span></code> package to handle vector data. This replaces the  a lot of functionality in older packages like <code class="docutils literal notranslate"><span class="pre">sp</span></code> and <code class="docutils literal notranslate"><span class="pre">rgdal</span></code> under a more elegant and consistent interface.</p>
<p>Note that in the background, all of these packages are just wrappers to the powerful, fast and open-source GIS libraries <code class="docutils literal notranslate"><span class="pre">gdal</span></code> (geospatial data handling), <code class="docutils literal notranslate"><span class="pre">geos</span></code> (vector data geometry) and <code class="docutils literal notranslate"><span class="pre">proj</span></code> (coordinate system projections).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package is also used for most of the vector data GIS in the core textbook:</p>
<p><a class="reference external" href="https://geocompr.robinlovelace.net/index.html">https://geocompr.robinlovelace.net/index.html</a></p>
<div class="section" id="making-vectors-from-coordinates">
<h3>Making vectors from coordinates<a class="headerlink" href="#making-vectors-from-coordinates" title="Permalink to this headline">¶</a></h3>
<p>To start, let’s create a population density map for the British Isles, using the data below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pop_dens</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">n_km2</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">260</span><span class="p">,</span> <span class="m">67</span><span class="p">,</span><span class="m">151</span><span class="p">,</span> <span class="m">4500</span><span class="p">,</span> <span class="m">133</span><span class="p">),</span> 
                       <span class="n">country</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;England&#39;</span><span class="p">,</span><span class="s">&#39;Scotland&#39;</span><span class="p">,</span> <span class="s">&#39;Wales&#39;</span><span class="p">,</span> <span class="s">&#39;London&#39;</span><span class="p">,</span> <span class="s">&#39;Northern Ireland&#39;</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">pop_dens</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  n_km2          country
1   260          England
2    67         Scotland
3   151            Wales
4  4500           London
5   133 Northern Ireland
</pre></div>
</div>
</div>
</div>
<p>We want to get polygon features that look <em>approximately</em>  like the map below. So, we are aiming to have separate polygons for Scotland, England, Wales, Northern Ireland and Eire. We also want to isolate London from the rest of England. This map is going to be <em>very</em> approximate and we’re going to put the map together in a rather peculiar way, to show different geometry types and operations.</p>
<p>The map below looks a bit peculiar - squashed vertically - because it is plotting latitude and longitude degrees as if they are constant units and they are not. We’ll come back to this in the section on reprojection below.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in st_cast.GEOMETRYCOLLECTION(X[[i]], ...):
“only first part of geometrycollection is retained”
</pre></div>
</div>
<img alt="../_images/practical_1_7_1.png" src="../_images/practical_1_7_1.png" />
</div>
</div>
<p>In order to create vector data, we need to provide a set of coordinates for the points. For different kinds of vector geometries (POINT, LINESTRING, POLYGON), the coordinates are provided in different ways. Here, we are just using very simple polygons to show the countries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create coordinates  for each country </span>
<span class="c1"># - this creates a matrix of pairs of coordinates forming the edge of the polygon. </span>
<span class="c1"># - note that they have to _close_: the first and last coordinate must be the same.</span>
<span class="n">scotland</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-5</span><span class="p">,</span> <span class="m">58.6</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span> <span class="m">58.6</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-4</span><span class="p">,</span> <span class="m">57.6</span><span class="p">),</span> 
                  <span class="nf">c</span><span class="p">(</span><span class="m">-1.5</span><span class="p">,</span> <span class="m">57.6</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span> <span class="m">55.8</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span> <span class="m">55</span><span class="p">),</span> 
                  <span class="nf">c</span><span class="p">(</span><span class="m">-5</span><span class="p">,</span> <span class="m">55</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-6</span><span class="p">,</span> <span class="m">56</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-5</span><span class="p">,</span> <span class="m">58.6</span><span class="p">))</span>
<span class="n">england</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">55.8</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="m">52.8</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">1.6</span><span class="p">,</span> <span class="m">52.8</span><span class="p">),</span> 
                  <span class="nf">c</span><span class="p">(</span><span class="m">0.7</span><span class="p">,</span> <span class="m">50.7</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-5.7</span><span class="p">,</span><span class="m">50</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-2.7</span><span class="p">,</span> <span class="m">51.5</span><span class="p">),</span> 
                  <span class="nf">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span> <span class="m">53.4</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span> <span class="m">55</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">55.8</span><span class="p">))</span>
<span class="n">wales</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-2.5</span><span class="p">,</span> <span class="m">51.3</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-5.3</span><span class="p">,</span><span class="m">51.8</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-4.5</span><span class="p">,</span> <span class="m">53.4</span><span class="p">),</span>
                  <span class="nf">c</span><span class="p">(</span><span class="m">-2.8</span><span class="p">,</span> <span class="m">53.4</span><span class="p">),</span>  <span class="nf">c</span><span class="p">(</span><span class="m">-2.5</span><span class="p">,</span> <span class="m">51.3</span><span class="p">))</span>
<span class="n">ireland</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span><span class="m">51.5</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span> <span class="m">54.2</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-7.5</span><span class="p">,</span> <span class="m">55.3</span><span class="p">),</span>
                  <span class="nf">c</span><span class="p">(</span><span class="m">-5.9</span><span class="p">,</span> <span class="m">55.3</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-5.9</span><span class="p">,</span> <span class="m">52.2</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span><span class="m">51.5</span><span class="p">))</span>

<span class="c1"># Convert these coordinates into feature geometries</span>
<span class="c1"># - these are simple coordinate sets with no projection information</span>
<span class="n">scotland</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">scotland</span><span class="p">))</span>
<span class="n">england</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">england</span><span class="p">))</span>
<span class="n">wales</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">wales</span><span class="p">))</span>
<span class="n">ireland</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">ireland</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can combine these into a simple feature column (<code class="docutils literal notranslate"><span class="pre">sfc</span></code>), which also allows us to set the coordinate reference system (<code class="docutils literal notranslate"><span class="pre">crs</span></code> or projection) of the data. The mystery <code class="docutils literal notranslate"><span class="pre">4326</span></code> in the code below is explained later on!</p>
<p>One other thing to note here is that <code class="docutils literal notranslate"><span class="pre">sf</span></code> automatically tries to scale the aspect ratio of plots of geographic coordinate data based on their latitude - this makes them look less squashed. We are actively suppressing that here by setting an aspect ratio of one (<code class="docutils literal notranslate"><span class="pre">asp=1</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combine geometries into a simple feature column</span>
<span class="n">uk_eire</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">wales</span><span class="p">,</span> <span class="n">england</span><span class="p">,</span> <span class="n">scotland</span><span class="p">,</span> <span class="n">ireland</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_11_0.png" src="../_images/practical_1_11_0.png" />
</div>
</div>
</div>
<div class="section" id="making-vector-points-from-a-dataframe">
<h3>Making vector points from a dataframe<a class="headerlink" href="#making-vector-points-from-a-dataframe" title="Permalink to this headline">¶</a></h3>
<p>We can easily turn a data frame with coordinates in columns into a point vector data source. The example here creates point locations for capital cities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_capitals</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">long</span><span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">-0.1</span><span class="p">,</span> <span class="m">-3.2</span><span class="p">,</span> <span class="m">-3.2</span><span class="p">,</span> <span class="m">-6.0</span><span class="p">,</span> <span class="m">-6.25</span><span class="p">),</span>
                               <span class="n">lat</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">51.5</span><span class="p">,</span> <span class="m">51.5</span><span class="p">,</span> <span class="m">55.8</span><span class="p">,</span> <span class="m">54.6</span><span class="p">,</span> <span class="m">53.30</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;London&#39;</span><span class="p">,</span> <span class="s">&#39;Cardiff&#39;</span><span class="p">,</span> <span class="s">&#39;Edinburgh&#39;</span><span class="p">,</span> <span class="s">&#39;Belfast&#39;</span><span class="p">,</span> <span class="s">&#39;Dublin&#39;</span><span class="p">))</span>

<span class="c1"># Indicate which fields in the data frame contain the coordinates</span>
<span class="n">uk_eire_capitals</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">uk_eire_capitals</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;long&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire_capitals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 5 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -6.25 ymin: 51.5 xmax: -0.1 ymax: 55.8
CRS:           EPSG:4326
       name           geometry
1    London  POINT (-0.1 51.5)
2   Cardiff  POINT (-3.2 51.5)
3 Edinburgh  POINT (-3.2 55.8)
4   Belfast    POINT (-6 54.6)
5    Dublin POINT (-6.25 53.3)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="vector-geometry-operations">
<h3>Vector geometry operations<a class="headerlink" href="#vector-geometry-operations" title="Permalink to this headline">¶</a></h3>
<p>That is a good start but we’ve got some issues:</p>
<ol class="simple">
<li><p>We are missing a separate polygon for London.</p></li>
<li><p>The boundary for Wales is poorly digitized - we want a common border with England.</p></li>
<li><p>We have not separated Northern Ireland from Eire.</p></li>
</ol>
<p>We’ll handle those by using some geometry operations. First, we will use the <strong>buffer</strong> operation to create a polygon for London, which we define as anywhere within a quarter degree of St. Pauls Cathedral. This is a fairly stupid thing to do - we will come back to why later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">st_pauls</span> <span class="o">&lt;-</span> <span class="nf">st_point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-0.098056</span><span class="p">,</span> <span class="m">51.513611</span><span class="p">))</span>
<span class="n">london</span> <span class="o">&lt;-</span> <span class="nf">st_buffer</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="m">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also need to remove London from the England polygon so that we can set different population densities for the two regions. This uses the <strong>difference</strong> operation. Note that the order of the arguments to this function matter: we want the bits of England that are different from London.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">england_no_london</span> <span class="o">&lt;-</span> <span class="nf">st_difference</span><span class="p">(</span><span class="n">england</span><span class="p">,</span> <span class="n">london</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the resulting feature now has a different structure. The <code class="docutils literal notranslate"><span class="pre">lengths</span></code> function allows us to see the number of components in a polygon and how many points are in each component. If we look at the polygon for Scotland:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">lengths</span><span class="p">(</span><span class="n">scotland</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">18</div></div>
</div>
<p>There is a single component with 18 points. If we look at the new <code class="docutils literal notranslate"><span class="pre">england_no_london</span></code> feature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">lengths</span><span class="p">(</span><span class="n">england_no_london</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>18</li><li>242</li></ol>
</div></div>
</div>
<p>There are <strong>two</strong> components (or rings): one ring for the 18 points along the external border and a second ring of 242 points for the internal hole. Like <code class="docutils literal notranslate"><span class="pre">scotland</span></code>, all the other un-holey polygons only contain a single ring for their external border.</p>
<p>We can use the same operation to tidy up Wales: in this case we want the bits of Wales that are different from England.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">wales</span> <span class="o">&lt;-</span> <span class="nf">st_difference</span><span class="p">(</span><span class="n">wales</span><span class="p">,</span> <span class="n">england</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we will use the <strong>intersection</strong> operation to separate Northern Ireland from the island of Ireland. First we create a rough polygon that includes Northern Ireland and sticks out into the sea; then we find the intersection and difference of that with the Ireland polygon to get Northern Ireland and Eire.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># A rough polygon that includes Northern Ireland and surrounding sea.</span>
<span class="c1"># - not the alternative way of providing the coordinates</span>
<span class="n">ni_area</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-8.1</span><span class="p">,</span> <span class="m">-6</span><span class="p">,</span> <span class="m">-5</span><span class="p">,</span> <span class="m">-6</span><span class="p">,</span> <span class="m">-8.1</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">54.4</span><span class="p">,</span> <span class="m">56</span><span class="p">,</span> <span class="m">55</span><span class="p">,</span> <span class="m">54</span><span class="p">,</span> <span class="m">54.4</span><span class="p">))))</span>

<span class="n">northern_ireland</span> <span class="o">&lt;-</span> <span class="nf">st_intersection</span><span class="p">(</span><span class="n">ireland</span><span class="p">,</span> <span class="n">ni_area</span><span class="p">)</span>
<span class="n">eire</span> <span class="o">&lt;-</span> <span class="nf">st_difference</span><span class="p">(</span><span class="n">ireland</span><span class="p">,</span> <span class="n">ni_area</span><span class="p">)</span>

<span class="c1"># Combine the final geometries</span>
<span class="n">uk_eire</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">wales</span><span class="p">,</span> <span class="n">england_no_london</span><span class="p">,</span> <span class="n">scotland</span><span class="p">,</span> <span class="n">london</span><span class="p">,</span> <span class="n">northern_ireland</span><span class="p">,</span> <span class="n">eire</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/practical_1_26_0.png" src="../_images/practical_1_26_0.png" />
</div>
</div>
</div>
<div class="section" id="features-and-geometries">
<h3>Features and geometries<a class="headerlink" href="#features-and-geometries" title="Permalink to this headline">¶</a></h3>
<p>That <code class="docutils literal notranslate"><span class="pre">uk_eire</span></code> object now contains 6 <strong>features</strong>: a feature is a set of one or more vector GIS geometries that represent a spatial unit we are interested in. At the moment, <code class="docutils literal notranslate"><span class="pre">uk_eire</span></code> hold six features, each of which consists of a single polygon. The England feature is slightly more complex because it as a hole in it. We can create a single feature that contains all of those geometries in one <code class="docutils literal notranslate"><span class="pre">MULTIPOLYGON</span></code> geometry by using the <strong>union</strong> operation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># compare six Polygon features with one Multipolygon feature</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geometry set for 6 features 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
First 5 geometries:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((-2.942105 51.37895, -5.3 51.8, -4.5 5...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((-2 55.8, 0.5 52.8, 1.6 52.8, 0.7 50.7...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((-5 58.6, -3 58.6, -4 57.6, -1.5 57.6,...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((0.151944 51.51361, 0.1516014 51.50053...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((-6.91875 55.3, -5.9 55.3, -5.9 54.1, ...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># make the UK into a single feature</span>
<span class="n">uk_country</span> <span class="o">&lt;-</span> <span class="nf">st_union</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">[</span><span class="m">-6</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_country</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geometry set for 1 feature 
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -8.1 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MULTIPOLYGON (((-6 56, -5 55, -3 55, -3 53.4, -...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot them</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nf">rainbow</span><span class="p">(</span><span class="m">6</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_capitals</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_country</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;lightblue&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_31_0.png" src="../_images/practical_1_31_0.png" />
</div>
</div>
<!-- ## Geometry errors and validity

You can seen something odd about the `uk_country` map: it has a line at the southern end of the Welsh border. It is a bit like the Severn estuary, but If you zoom in on that area you would find it has basically zero width.

That isn't technically an error - it is just  that the vector processing is able to work with arbitrarily small differences and has preserved these two parallel edges. We can tidy it up by using a bit of a hack: buffer the whole feature by an arbitrarily small amount.

```{r validity}
#st_is_valid(uk_country)
#uk_country <- st_buffer(uk_country, 0.000001)
```

However, sometimes geometries are not valid, for example




Zooming in and exploring GIS data is one of the things that R is currently poor at - you are better off installing QGIS if you want to look over your data. -->
</div>
<div class="section" id="vector-data-and-attributes">
<h3>Vector data and attributes<a class="headerlink" href="#vector-data-and-attributes" title="Permalink to this headline">¶</a></h3>
<p>So far we just have the vector geometries, but GIS data is about pairing spatial features with data about those features, often called <em>attributes</em> or <em>properties</em>. The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package introduces the <code class="docutils literal notranslate"><span class="pre">sf</span></code> object type: basically this is just a normal data frame with an additional field containing <strong>simple feature</strong> data. We can do that here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire</span> <span class="o">&lt;-</span> <span class="nf">st_sf</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;Wales&#39;</span><span class="p">,</span> <span class="s">&#39;England&#39;</span><span class="p">,</span><span class="s">&#39;Scotland&#39;</span><span class="p">,</span> <span class="s">&#39;London&#39;</span><span class="p">,</span> 
                        <span class="s">&#39;Northern Ireland&#39;</span><span class="p">,</span> <span class="s">&#39;Eire&#39;</span><span class="p">),</span>
                 <span class="n">geometry</span><span class="o">=</span><span class="n">uk_eire</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_33_0.png" src="../_images/practical_1_33_0.png" />
</div>
</div>
<p>Since an <code class="docutils literal notranslate"><span class="pre">sf</span></code> object is an extended data frame, we can add attributes by adding fields directly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire</span><span class="o">$</span><span class="n">capital</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Cardiff&#39;</span><span class="p">,</span> <span class="s">&#39;London&#39;</span><span class="p">,</span> <span class="s">&#39;Edinburgh&#39;</span><span class="p">,</span> 
                     <span class="kc">NA</span><span class="p">,</span> <span class="s">&#39;Belfast&#39;</span><span class="p">,</span><span class="s">&#39;Dublin&#39;</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name                       geometry   capital
1            Wales POLYGON ((-2.942105 51.3789...   Cardiff
2          England POLYGON ((-2 55.8, 0.5 52.8...    London
3         Scotland POLYGON ((-5 58.6, -3 58.6,... Edinburgh
4           London POLYGON ((0.151944 51.51361...      &lt;NA&gt;
5 Northern Ireland POLYGON ((-6.91875 55.3, -5...   Belfast
6             Eire POLYGON ((-10 51.5, -10 54....    Dublin
</pre></div>
</div>
</div>
</div>
<p>A more useful - and less error prone - technique is to use the <code class="docutils literal notranslate"><span class="pre">merge</span></code> command to match data in from the <code class="docutils literal notranslate"><span class="pre">pop_dens</span></code> data frame. The <code class="docutils literal notranslate"><span class="pre">merge</span></code> function allows us to set columns in two data frames that containing matching values and uses those to merge the data together.</p>
<ul class="simple">
<li><p>We need to use <code class="docutils literal notranslate"><span class="pre">by.x</span></code> and <code class="docutils literal notranslate"><span class="pre">by.y</span></code> to say which columns we expect to match, but if the column names were identical in the two frames, we could just use <code class="docutils literal notranslate"><span class="pre">by</span></code>.</p></li>
<li><p>The default for <code class="docutils literal notranslate"><span class="pre">merge</span></code> is to drop rows when it doesn’t find matching data. So here, we have to also use <code class="docutils literal notranslate"><span class="pre">all.x=TRUE</span></code>, otherwise Eire will be dropped from the spatial data because it has no population density estimate in the data frame.</p></li>
</ul>
<p>If we look at the result, we get some header information about the spatial data and then something that looks very like a data frame printout, with the extra <code class="docutils literal notranslate"><span class="pre">geometry</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire</span> <span class="o">&lt;-</span> <span class="nf">merge</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="n">pop_dens</span><span class="p">,</span> <span class="n">by.x</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">by.y</span><span class="o">=</span><span class="s">&#39;country&#39;</span><span class="p">,</span> <span class="n">all.x</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name   capital n_km2                       geometry
1             Eire    Dublin    NA POLYGON ((-10 51.5, -10 54....
2          England    London   260 POLYGON ((-2 55.8, 0.5 52.8...
3           London      &lt;NA&gt;  4500 POLYGON ((0.151944 51.51361...
4 Northern Ireland   Belfast   133 POLYGON ((-6.91875 55.3, -5...
5         Scotland Edinburgh    67 POLYGON ((-5 58.6, -3 58.6,...
6            Wales   Cardiff   151 POLYGON ((-2.942105 51.3789...
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="spatial-attributes">
<h3>Spatial attributes<a class="headerlink" href="#spatial-attributes" title="Permalink to this headline">¶</a></h3>
<p>One common thing that people want to know are spatial attributes of geometries and there are a range of commands to find these things out. One thing we might want are the <strong>centroids</strong> of features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_centroids</span> <span class="o">&lt;-</span> <span class="nf">st_centroid</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
<span class="nf">st_coordinates</span><span class="p">(</span><span class="n">uk_eire_centroids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 6 × 2 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>X</th><th scope=col>Y</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>-8.106654</td><td>53.20298</td></tr>
	<tr><th scope=row>2</th><td>-1.475674</td><td>52.43422</td></tr>
	<tr><th scope=row>3</th><td>-0.098056</td><td>51.51333</td></tr>
	<tr><th scope=row>4</th><td>-6.718765</td><td>54.66912</td></tr>
	<tr><th scope=row>5</th><td>-3.871562</td><td>56.63953</td></tr>
	<tr><th scope=row>6</th><td>-3.854211</td><td>52.39694</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package warns us here that this isn’t a sensible thing to do. There isn’t a good way to calculate a true centroid for geographic coordinates - we’ll come back to this in the section on reprojection.</p>
<p>Two other simple ones are the <strong>length</strong> of a feature and its <strong>area</strong>. Note that here <code class="docutils literal notranslate"><span class="pre">sf</span></code> is able to do something clever behind the scenes. Rather than give us answers in units of degrees, it notes that we have a goegraphic coordinate system and instead uses internal transformations to give us back accurate distances and areas using metres. Under the hood, it is using calculations on the surface of a sphere, so called <a class="reference external" href="https://en.wikipedia.org/wiki/Great-circle_distance">great circle distances</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire</span><span class="o">$</span><span class="n">area</span> <span class="o">&lt;-</span> <span class="nf">st_area</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
<span class="c1"># To calculate a &#39;length&#39; of a polygon, you have to </span>
<span class="c1"># convert it to a LINESTRING or a MULTILINESTRING</span>
<span class="c1"># Using MULTILINESTRING will automatically </span>
<span class="c1"># include all perimeter of a polygon (including holes).</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">length</span> <span class="o">&lt;-</span> <span class="nf">st_length</span><span class="p">(</span><span class="nf">st_cast</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="s">&#39;MULTILINESTRING&#39;</span><span class="p">))</span>
<span class="c1"># Look at the result</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 5 fields
Attribute-geometry relationship: 3 constant, 0 aggregate, 0 identity, 2 NA&#39;s
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name   capital n_km2                       geometry
1             Eire    Dublin    NA POLYGON ((-10 51.5, -10 54....
2          England    London   260 POLYGON ((-2 55.8, 0.5 52.8...
3           London      &lt;NA&gt;  4500 POLYGON ((0.151944 51.51361...
4 Northern Ireland   Belfast   133 POLYGON ((-6.91875 55.3, -5...
5         Scotland Edinburgh    67 POLYGON ((-5 58.6, -3 58.6,...
6            Wales   Cardiff   151 POLYGON ((-2.942105 51.3789...
                area        length
1  80224782361 [m^2] 1324119.2 [m]
2 125488900310 [m^2] 2058789.3 [m]
3   1510155053 [m^2]  143591.5 [m]
4  13595479622 [m^2]  479891.1 [m]
5  75904870952 [m^2] 1252736.0 [m]
6  28834611074 [m^2]  688614.9 [m]
</pre></div>
</div>
</div>
</div>
<p>Notice that those fields display units after the values. The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package often creates data with explicit units, using the <code class="docutils literal notranslate"><span class="pre">units</span></code> package. That is nicely precise but you may need to know how to handle the values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can change units in a neat way</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">area</span> <span class="o">&lt;-</span> <span class="nf">set_units</span><span class="p">(</span><span class="n">uk_eire</span><span class="o">$</span><span class="n">area</span><span class="p">,</span> <span class="s">&#39;km^2&#39;</span><span class="p">)</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">length</span> <span class="o">&lt;-</span> <span class="nf">set_units</span><span class="p">(</span><span class="n">uk_eire</span><span class="o">$</span><span class="n">length</span><span class="p">,</span> <span class="s">&#39;km&#39;</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 5 fields
Attribute-geometry relationship: 3 constant, 0 aggregate, 0 identity, 2 NA&#39;s
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name   capital n_km2                       geometry
1             Eire    Dublin    NA POLYGON ((-10 51.5, -10 54....
2          England    London   260 POLYGON ((-2 55.8, 0.5 52.8...
3           London      &lt;NA&gt;  4500 POLYGON ((0.151944 51.51361...
4 Northern Ireland   Belfast   133 POLYGON ((-6.91875 55.3, -5...
5         Scotland Edinburgh    67 POLYGON ((-5 58.6, -3 58.6,...
6            Wales   Cardiff   151 POLYGON ((-2.942105 51.3789...
               area         length
1  80224.782 [km^2] 1324.1192 [km]
2 125488.900 [km^2] 2058.7893 [km]
3   1510.155 [km^2]  143.5915 [km]
4  13595.480 [km^2]  479.8911 [km]
5  75904.871 [km^2] 1252.7360 [km]
6  28834.611 [km^2]  688.6149 [km]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># And it won&#39;t let you make silly error like turning a length into weight</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">area</span> <span class="o">&lt;-</span> <span class="nf">set_units</span><span class="p">(</span><span class="n">uk_eire</span><span class="o">$</span><span class="n">area</span><span class="p">,</span> <span class="s">&#39;kg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error: cannot convert km^2 into kg
Traceback:

1. set_units(uk_eire$area, &quot;kg&quot;)
2. set_units.units(uk_eire$area, &quot;kg&quot;)
3. `units&lt;-`(`*tmp*`, value = as_units(value, ...))
4. `units&lt;-.units`(`*tmp*`, value = as_units(value, ...))
5. stop(paste(&quot;cannot convert&quot;, units(x), &quot;into&quot;, value), call. = FALSE)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or you can simply convert the `units` version to simple numbers</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">length</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">uk_eire</span><span class="o">$</span><span class="n">length</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A final useful example is the <strong>distance</strong> between objects: <code class="docutils literal notranslate"><span class="pre">sf</span></code> gives us the closest distance between geometries, which might be zero if two features overlap or touch, as in the neighbouring polygons in our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_distance</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units: [m]
          [,1]     [,2]     [,3]      [,4]      [,5]     [,6]
[1,]      0.00 189032.0 387664.3      0.00  89051.48  51928.7
[2,] 189032.04      0.0      0.0 184905.78      0.00      0.0
[3,] 387664.31      0.0      0.0 462098.10 406857.16 162778.6
[4,]      0.00 184905.8 462098.1      0.00  33359.85 119165.8
[5,]  89051.48      0.0 406857.2  33359.85      0.00 177902.3
[6,]  51928.70      0.0 162778.6 119165.80 177902.34      0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_distance</span><span class="p">(</span><span class="n">uk_eire_centroids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units: [m]
         [,1]     [,2]     [,3]     [,4]     [,5]     [,6]
[1,]      0.0 453549.8 575022.5 186624.2 468069.2 299552.0
[2,] 453549.8      0.0 139242.9 426112.3 492415.7 161361.2
[3,] 575022.5 139242.9      0.0 564047.9 620666.1 275472.6
[4,] 186624.2 426112.3 564047.9      0.0 282632.2 315659.1
[5,] 468069.2 492415.7 620666.1 282632.2      0.0 471755.6
[6,] 299552.0 161361.2 275472.6 315659.1 471755.6      0.0
</pre></div>
</div>
</div>
</div>
<p>Again, <code class="docutils literal notranslate"><span class="pre">sf</span></code> is noting that we have a geographic coordinate system and internally calculating distances in metres.</p>
</div>
<div class="section" id="plotting-sf-objects">
<h3>Plotting <code class="docutils literal notranslate"><span class="pre">sf</span></code> objects<a class="headerlink" href="#plotting-sf-objects" title="Permalink to this headline">¶</a></h3>
<p>If you plot an <code class="docutils literal notranslate"><span class="pre">sf</span></code> object, the default is to plot a map for every attribute. You can pick a field to plot by using square brackets. So, now we can show our map of population density:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">[</span><span class="s">&#39;n_km2&#39;</span><span class="p">],</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_51_0.png" src="../_images/practical_1_51_0.png" />
</div>
</div>
<p>If you  just want to plot the geometries, without any labelling or colours, the <code class="docutils literal notranslate"><span class="pre">st_geometry</span></code> function can be used to temporarily strip off attributes - see the reprojection section below for an example.</p>
<div class="admonition-scale-the-legend admonition">
<p class="admonition-title">Scale the legend</p>
<p>The scale on that plot isn’t very helpful. Look at <code class="docutils literal notranslate"><span class="pre">?plot.sf</span></code> and see if you can get a log scale on the right.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># You could simply log the data:</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">log_n_km2</span> <span class="o">&lt;-</span> <span class="nf">log10</span><span class="p">(</span><span class="n">uk_eire</span><span class="o">$</span><span class="n">n_km2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">[</span><span class="s">&#39;log_n_km2&#39;</span><span class="p">],</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="c1"># Or you can have logarithimic labelling using logz</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">[</span><span class="s">&#39;n_km2&#39;</span><span class="p">],</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">logz</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_53_0.png" src="../_images/practical_1_53_0.png" />
<img alt="../_images/practical_1_53_1.png" src="../_images/practical_1_53_1.png" />
</div>
</div>
</div>
<div class="section" id="reprojecting-vector-data">
<h3>Reprojecting vector data<a class="headerlink" href="#reprojecting-vector-data" title="Permalink to this headline">¶</a></h3>
<p>First, in the examples above we have been <strong>asserting</strong> that we have data with a particular projection (<code class="docutils literal notranslate"><span class="pre">4326</span></code>). This is <strong>not</strong> reprojection: we are simply saying that we know these coordinates are in this projection and setting that projection.</p>
<p>That mysterious <code class="docutils literal notranslate"><span class="pre">4326</span></code> is just a unique numeric code in the EPSG database of spatial coordinate systems: <span class="xref myst">http://epsg.io/</span>. The code acts a shortcut for the often complicated sets of parameters and transformations that define a particular projection. Here <code class="docutils literal notranslate"><span class="pre">4326</span></code> is the <a class="reference external" href="http://epsg.io/4326">WGS84</a> geographic coordinate system which is extremely widely used. Most GPS data is collected in WGS84, for example.</p>
<p>Reprojection is moving data from one set of coordinates to another. For vector data, this is a relatively straightforward process. The spatial information in a vector dataset are coordinates in space, and projections are just sets of equations, so it is simple to apply the equations to the coordinates. We’ll come back to this for raster data: coordinate transormation is identical but transforming the data stored in a raster is conceptually more complex.</p>
<p>Reprojecting data is often used to convert from a geographic coordinate system - with units of degrees - to a projected coordinate system with linear units. Remember that projected coordinate systems are always a trade off between conserving distance, shape, area and bearings and it is important to pick one that is appropriate to your area or analysis.</p>
<p>We will reproject our UK and Eire map onto a good choice of local projected coordinate system: the <a class="reference external" href="http://epsg.io/27700">British National Grid</a>. We can also use a bad choice: the <a class="reference external" href="http://epsg.io/32650">UTM 50N</a> projection, which is appropriate for Borneo. It does not end well if we use it to project the UK and Eire.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># British National Grid (EPSG:27700)</span>
<span class="n">uk_eire_BNG</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="m">27700</span><span class="p">)</span>
<span class="c1"># UTM50N (EPSG:32650)</span>
<span class="n">uk_eire_UTM50N</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="m">32650</span><span class="p">)</span>
<span class="c1"># The bounding boxes of the data shows the change in units</span>
<span class="nf">st_bbox</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> xmin  ymin  xmax  ymax 
-10.0  50.0   1.6  58.6 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_bbox</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      xmin       ymin       xmax       ymax 
-154811.97   17655.72  642773.71  971900.65 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the results</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">),</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;WGS 84&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;OSGB 1936 / BNG&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_UTM50N</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;UTM 50N&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_57_0.png" src="../_images/practical_1_57_0.png" />
</div>
</div>
<div class="section" id="proj4-strings">
<h4>Proj4 strings<a class="headerlink" href="#proj4-strings" title="Permalink to this headline">¶</a></h4>
<p>Those EPSG ID codes save us from <code class="docutils literal notranslate"><span class="pre">proj4</span></code> strings (see <a class="reference external" href="https://proj.org/">here</a>): these text strings contain often long and confusing sets of options and parameters that actually define a particular projection. The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package is kind to us, but some other packages are not, so you may see these in R and you can also see the <code class="docutils literal notranslate"><span class="pre">proj4</span></code> strings on the EPSG website:</p>
<ul class="simple">
<li><p><strong>4326</strong>: <code class="docutils literal notranslate"><span class="pre">+init=EPSG:4326</span> <span class="pre">+proj=longlat</span> <span class="pre">+datum=WGS84</span> <span class="pre">+no_defs</span> <span class="pre">+ellps=WGS84</span> <span class="pre">+towgs84=0,0,0</span></code></p></li>
<li><p><strong>27700</strong>: <code class="docutils literal notranslate"><span class="pre">+proj=tmerc</span> <span class="pre">+lat_0=49</span> <span class="pre">+lon_0=-2</span> <span class="pre">+k=0.9996012717</span> <span class="pre">+x_0=400000</span> <span class="pre">+y_0=-100000+ellps=airy</span></code><br />
<code class="docutils literal notranslate"><span class="pre">+towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489</span> <span class="pre">+units=m</span> <span class="pre">+no_defs</span></code></p></li>
<li><p><strong>32650</strong>: <code class="docutils literal notranslate"><span class="pre">+proj=utm</span> <span class="pre">+zone=50</span> <span class="pre">+datum=WGS84</span> <span class="pre">+units=m</span> <span class="pre">+no_defs</span></code></p></li>
</ul>
</div>
<div class="section" id="degrees-are-not-constant">
<h4>Degrees are not constant<a class="headerlink" href="#degrees-are-not-constant" title="Permalink to this headline">¶</a></h4>
<p>The units of geographic coordinate systems are <strong>angles</strong> of latitide and longitude. These are not a constant unit of distance and as lines of longitude converge towards to pole, the physical length of a degree decreases.  This is why our 0.25° buffered point for London is stupid and why it is distorted in the projected data.</p>
<p>At the latitude of London, a degree longitude is about 69km and a degree latitude is about 111 km. Again <code class="docutils literal notranslate"><span class="pre">st_distance</span></code> is noting that we have geographic coordinates and is returning great circle distances in metres.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up some points separated by 1 degree latitude and longitude from St. Pauls</span>
<span class="n">st_pauls</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="n">one_deg_west_pt</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">st_pauls</span> <span class="o">-</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span> <span class="c1"># near Goring</span>
<span class="n">one_deg_north_pt</span> <span class="o">&lt;-</span>  <span class="nf">st_sfc</span><span class="p">(</span><span class="n">st_pauls</span> <span class="o">+</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span> <span class="c1"># near Peterborough</span>
<span class="c1"># Calculate the distance between St Pauls and each point</span>
<span class="nf">st_distance</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="n">one_deg_west_pt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units: [m]
         [,1]
[1,] 69199.37
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_distance</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="n">one_deg_north_pt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units: [m]
         [,1]
[1,] 111195.1
</pre></div>
</div>
</div>
</div>
<p>Note that the great circle distance between London and Goring - which accounts for the curvature of the earth  - is roughly 17 metres longer than the distance between the same coordinates projected onto the British National Grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_distance</span><span class="p">(</span><span class="nf">st_transform</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="m">27700</span><span class="p">),</span> 
            <span class="nf">st_transform</span><span class="p">(</span><span class="n">one_deg_west_pt</span><span class="p">,</span> <span class="m">27700</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units: [m]
         [,1]
[1,] 69401.97
</pre></div>
</div>
</div>
</div>
<div class="admonition-improve-the-london-feature admonition">
<p class="admonition-title">Improve the London feature</p>
<p>Our feature for London would be far better if it used a constant 25km buffer around St. Pauls, rather than the poor atttempt using degrees. The resulting map is below - try to recreate it.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># transform St Pauls to BNG and buffer using 25 km</span>
<span class="n">london_bng</span> <span class="o">&lt;-</span> <span class="nf">st_buffer</span><span class="p">(</span><span class="nf">st_transform</span><span class="p">(</span><span class="n">st_pauls</span><span class="p">,</span> <span class="m">27700</span><span class="p">),</span> <span class="m">25000</span><span class="p">)</span>
<span class="c1"># In one line, transform england to BNG and cut out London</span>
<span class="n">england_not_london_bng</span> <span class="o">&lt;-</span> <span class="nf">st_difference</span><span class="p">(</span><span class="nf">st_transform</span><span class="p">(</span><span class="nf">st_sfc</span><span class="p">(</span><span class="n">england</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">),</span> <span class="m">27700</span><span class="p">),</span> <span class="n">london_bng</span><span class="p">)</span>
<span class="c1"># project the other features and combine everything together</span>
<span class="n">others_bng</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="nf">st_sfc</span><span class="p">(</span><span class="n">eire</span><span class="p">,</span> <span class="n">northern_ireland</span><span class="p">,</span> <span class="n">scotland</span><span class="p">,</span> <span class="n">wales</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">),</span> <span class="m">27700</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">others_bng</span><span class="p">,</span> <span class="n">london_bng</span><span class="p">,</span> <span class="n">england_not_london_bng</span><span class="p">)</span>
<span class="c1"># Plot that and marvel at the nice circular feature around London</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;25km radius London&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_64_0.png" src="../_images/practical_1_64_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="rasters">
<h2>Rasters<a class="headerlink" href="#rasters" title="Permalink to this headline">¶</a></h2>
<p>Rasters are the other major type of spatial data. They consist of a regular grid in space, defined by a coordinate system, an origin point, a resolution and a number of rows and columns. They effectively hold a matrix of data. We will use the <code class="docutils literal notranslate"><span class="pre">raster</span></code> package to handle raster data.</p>
<div class="section" id="creating-a-raster">
<h3>Creating a raster<a class="headerlink" href="#creating-a-raster" title="Permalink to this headline">¶</a></h3>
<p>We are first going to build a simple raster dataset from scratch. We are setting the projection, the bounds and the resolution. The raster object initially has no data values associated with it, but we can set them.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">raster</span></code> package doesn’t support using EPSG codes as numbers, but does support them as a formatted text string: <code class="docutils literal notranslate"><span class="pre">+init=EPSG:4326</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty raster object covering UK and Eire</span>
<span class="n">uk_raster_WGS84</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">xmn</span><span class="o">=</span><span class="m">-11</span><span class="p">,</span>  <span class="n">xmx</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>  <span class="n">ymn</span><span class="o">=</span><span class="m">49.5</span><span class="p">,</span> <span class="n">ymx</span><span class="o">=</span><span class="m">59</span><span class="p">,</span> 
                          <span class="n">res</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&quot;+init=EPSG:4326&quot;</span><span class="p">)</span>
<span class="nf">hasValues</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">FALSE</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add data to the raster: just the number 1 to number of cells</span>
<span class="nf">values</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterLayer 
dimensions : 19, 26, 494  (nrow, ncol, ncell)
resolution : 0.5, 0.5  (x, y)
extent     : -11, 2, 49.5, 59  (xmin, xmax, ymin, ymax)
crs        : +init=EPSG:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
source     : memory
names      : layer 
values     : 1, 494  (min, max)
</pre></div>
</div>
</div>
</div>
<p>We can create a basic map of that, with the country borders over the top: <code class="docutils literal notranslate"><span class="pre">add=TRUE</span></code> adds the vector data to the existing map and the other options set border and fill colours. The ugly looking <code class="docutils literal notranslate"><span class="pre">#FFFFFF44</span></code> is a <a class="reference external" href="https://en.wikipedia.org/wiki/RGBA_color_space#RGBA_hexadecimal_(word-order)">RGBA colour code</a> that gives us a transparent gray fill for the polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;#FFFFFF44&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_69_0.png" src="../_images/practical_1_69_0.png" />
</div>
</div>
</div>
<div class="section" id="changing-raster-resolution">
<h3>Changing raster resolution<a class="headerlink" href="#changing-raster-resolution" title="Permalink to this headline">¶</a></h3>
<p>You can change a raster to have either coarser or finer resolution, but you have to <strong>think</strong> about what the data is and what it means when you <em>aggregate</em> or <em>disaggregate</em> the values. You might need to do this to make different data sources have the same resolution for an analysis, or because the data you are using is more detailed than you need or can analyse.</p>
<p>We’ll use a really simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a simple 4 x 4 square raster</span>
<span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span>
              <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span>
              <span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span>
              <span class="m">6</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">7</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">square</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="aggregating-rasters">
<h3>Aggregating rasters<a class="headerlink" href="#aggregating-rasters" title="Permalink to this headline">¶</a></h3>
<p>With aggregating, we choose an aggregation <em>factor</em> - how many cells to group - and then lump sets of cells together. So, for example, a factor of 2 will aggregate blocks of 2x2 cells.</p>
<p>The question is then, what value should we assign? If the data is continuous (e.g. height) then a mean or a maximum might make sense. However if the raster values represent categories (like land cover), then mean doesn’t make sense <em>at all</em>: the average of Forest (2) and  Moorland (3) codes is easy to calculate but is meaningless!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Average values</span>
<span class="n">square_agg_mean</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">mean</span><span class="p">)</span>
<span class="nf">as.matrix</span><span class="p">(</span><span class="n">square_agg_mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>1.25</td><td>3.25</td></tr>
	<tr><td>5.50</td><td>7.25</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum values</span>
<span class="n">square_agg_max</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">max</span><span class="p">)</span>
<span class="nf">as.matrix</span><span class="p">(</span><span class="n">square_agg_max</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>2</td><td>4</td></tr>
	<tr><td>6</td><td>8</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modal values for categories</span>
<span class="n">square_agg_modal</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">modal</span><span class="p">)</span>
<span class="nf">as.matrix</span><span class="p">(</span><span class="n">square_agg_modal</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>1</td><td>3</td></tr>
	<tr><td>5</td><td>7</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="admonition-issues-with-aggregation admonition">
<p class="admonition-title">Issues with aggregation</p>
<p>Even using the modal value, there is a problem with aggregating rasters with categories. This occurs in the example data - can you see what it is?</p>
</div>
<div class="toggle docutils container">
<p>The bottom left cell has a modal value of 5 even though there is no mode: there are two 5s and two 6s. You can use <code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code> to specify which value gets chosen but strictly there is no single mode.</p>
</div>
</div>
<div class="section" id="disaggregating-rasters">
<h3>Disaggregating rasters<a class="headerlink" href="#disaggregating-rasters" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">disaggregate</span></code> function also requires a factor, but this time the factor is the square root of the number of cells to <em>create</em> from each cell, rather than the number to merge. There is again a choice to make on what values to put in the cell. The obvious answer is simply to copy the parent cell value into each of the new cells: this is pretty simple and is fine for both continuous and categorical values. Another option is to <strong>interpolate</strong> between the values to provide a smoother gradient between cells. This does <strong>not</strong> make sense for a categorical variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copy parents</span>
<span class="n">square_disagg</span> <span class="o">&lt;-</span> <span class="nf">disaggregate</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="c1"># Interpolate</span>
<span class="n">square_disagg_interp</span> <span class="o">&lt;-</span> <span class="nf">disaggregate</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll show those values visually:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/practical_1_79_0.png" src="../_images/practical_1_79_0.png" />
</div>
</div>
</div>
<div class="section" id="resampling">
<h3>Resampling<a class="headerlink" href="#resampling" title="Permalink to this headline">¶</a></h3>
<p>Note that the previous two functions don’t change the <strong>origin</strong> or <strong>alignments of cell borders</strong> at all: they just lump or split values within the same grid framework.  If you need to match datasets and they have different origins and alignments then you need to use the more complex <code class="docutils literal notranslate"><span class="pre">resample</span></code> function. We won’t look at this further here because it is basically a simpler case of …</p>
</div>
<div class="section" id="reprojecting-a-raster">
<h3>Reprojecting a raster<a class="headerlink" href="#reprojecting-a-raster" title="Permalink to this headline">¶</a></h3>
<p>This is conceptually more difficult than reprojecting vector data but we’ve covered the main reasons above. You have a series of raster cell values in one projection and then want to insert representative values into a set of cells on a different projection. The borders of those new cells could have all sorts of odd relationships to the current ones.</p>
<p>In the example here, we are show how our 0.5° WGS84 raster for the UK and Eire compares to a 100km resolution raster on the British National Grid.</p>
<p>We can’t display that using actual raster data because they always need to plot on a regular grid. However we can create vector grids, using the new function <code class="docutils literal notranslate"><span class="pre">st_make_grid</span></code> and our other vector tools, to represent the cells in the two raster grids so we can overplot them. You can see how transferring cell values between those two raster grids gets complicated!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># make two simple `sfc` objects containing points in  the</span>
<span class="c1"># lower left and top right of the two grids</span>
<span class="n">uk_pts_WGS84</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="nf">st_point</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-11</span><span class="p">,</span> <span class="m">49.5</span><span class="p">)),</span> <span class="nf">st_point</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">59</span><span class="p">)),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="n">uk_pts_BNG</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="nf">st_point</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-2e5</span><span class="p">,</span> <span class="m">0</span><span class="p">)),</span> <span class="nf">st_point</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">7e5</span><span class="p">,</span> <span class="m">1e6</span><span class="p">)),</span> <span class="n">crs</span><span class="o">=</span><span class="m">27700</span><span class="p">)</span>

<span class="c1">#  Use st_make_grid to quickly create a polygon grid with the right cellsize</span>
<span class="n">uk_grid_WGS84</span> <span class="o">&lt;-</span> <span class="nf">st_make_grid</span><span class="p">(</span><span class="n">uk_pts_WGS84</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>
<span class="n">uk_grid_BNG</span> <span class="o">&lt;-</span> <span class="nf">st_make_grid</span><span class="p">(</span><span class="n">uk_pts_BNG</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="m">1e5</span><span class="p">)</span>

<span class="c1"># Reproject BNG grid into WGS84</span>
<span class="n">uk_grid_BNG_as_WGS84</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">uk_grid_BNG</span><span class="p">,</span> <span class="m">4326</span><span class="p">)</span>

<span class="c1"># Plot the features</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_grid_WGS84</span><span class="p">,</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-13</span><span class="p">,</span><span class="m">4</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;darkgreen&#39;</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_grid_BNG_as_WGS84</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_81_0.png" src="../_images/practical_1_81_0.png" />
</div>
</div>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">projectRaster</span></code> function, which gives us the choice of interpolating a representative value from the source data (<code class="docutils literal notranslate"><span class="pre">method='bilinear'</span></code>) or picking the cell value from the nearest neighbour to the new cell centre (<code class="docutils literal notranslate"><span class="pre">method='ngb'</span></code>). We first create the target raster - we don’t have to put any data into it - and use that as a template for the reprojected data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the target raster</span>
<span class="n">uk_raster_BNG</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">xmn</span><span class="o">=</span><span class="m">-200000</span><span class="p">,</span> <span class="n">xmx</span><span class="o">=</span><span class="m">700000</span><span class="p">,</span> <span class="n">ymn</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">ymx</span><span class="o">=</span><span class="m">1000000</span><span class="p">,</span>
                         <span class="n">res</span><span class="o">=</span><span class="m">100000</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&#39;+init=EPSG:27700&#39;</span><span class="p">)</span>
<span class="n">uk_raster_BNG_interp</span> <span class="o">&lt;-</span> <span class="nf">projectRaster</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">,</span> <span class="n">uk_raster_BNG</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">uk_raster_BNG_ngb</span> <span class="o">&lt;-</span> <span class="nf">projectRaster</span><span class="p">(</span><span class="n">uk_raster_WGS84</span><span class="p">,</span> <span class="n">uk_raster_BNG</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;ngb&#39;</span><span class="p">)</span>
<span class="c1"># compare the values in the top row</span>
<span class="nf">round</span><span class="p">(</span><span class="nf">values</span><span class="p">(</span><span class="n">uk_raster_BNG_interp</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">],</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">values</span><span class="p">(</span><span class="n">uk_raster_BNG_ngb</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>&lt;NA&gt;</li><li>31.36</li><li>30.02</li><li>29.87</li><li>30.91</li><li>33.14</li><li>36.56</li><li>41.17</li><li>&lt;NA&gt;</li></ol>
</div><div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>&lt;NA&gt;</li><li>29</li><li>33</li><li>36</li><li>39</li><li>43</li><li>46</li><li>50</li><li>&lt;NA&gt;</li></ol>
</div></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">NA</span></code> in the cell values in the top right and left. In the plot above, you can see that the centres of those red cells do not overlie the original grey grid and <code class="docutils literal notranslate"><span class="pre">projectRaster</span></code> has assigned an <code class="docutils literal notranslate"><span class="pre">NA</span></code> value. If we plot the two outputs you can see the more abrupt changes when using nearest neighbour reprojection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_raster_BNG_interp</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Interpolated&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_raster_BNG_ngb</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Nearest Neighbour&#39;</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_85_0.png" src="../_images/practical_1_85_0.png" />
</div>
</div>
<p>For a recent package with a strong focus on raster data handling, go and have a look at the <code class="docutils literal notranslate"><span class="pre">stars</span></code> package: <a class="reference external" href="https://r-spatial.github.io/stars/">https://r-spatial.github.io/stars/</a>.</p>
</div>
</div>
<div class="section" id="converting-between-vector-and-raster-data-types">
<h2>Converting between vector and raster data types<a class="headerlink" href="#converting-between-vector-and-raster-data-types" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you want to represent raster data in vector format or vice versa. It is usually worth thinking if you really want to do this - data usually comes in one format or another for a reason - but there are plenty of valid reasons to do it.</p>
<div class="section" id="vector-to-raster">
<h3>Vector to raster<a class="headerlink" href="#vector-to-raster" title="Permalink to this headline">¶</a></h3>
<p>Converting vector data to a raster is a bit like <code class="docutils literal notranslate"><span class="pre">reprojectRaster</span></code>: you provide the target raster and the vector data and put it all through the <code class="docutils literal notranslate"><span class="pre">rasterize</span></code> function. There are important differences in the way that different geometry types get rasterized. In each case, a vector attribute is chosen to assign cell values in ther raster.</p>
<ul class="simple">
<li><p><strong>POINT</strong>: If a point falls anywhere within a cell, that value is assigned to the cell.</p></li>
<li><p><strong>LINESTRING</strong>: If any part of the linestring falls within a cell, that value is assigned to the cell.</p></li>
<li><p><strong>POLYGON</strong>: If the centre of the cell falls within a polygon, the value from that polygon is assigned to the cell.</p></li>
</ul>
<p>It is common that a cell might have more than one possible value - for example if two points fall in a cell. The <code class="docutils literal notranslate"><span class="pre">rasterize</span></code> function has a <code class="docutils literal notranslate"><span class="pre">fun</span></code> argument that allows you to set rules to decide which value ‘wins’.</p>
<p>One problem here is that <code class="docutils literal notranslate"><span class="pre">raster</span></code> predates <code class="docutils literal notranslate"><span class="pre">sf</span></code> and wants the vector data in the older <code class="docutils literal notranslate"><span class="pre">Spatial</span></code> data type from the <code class="docutils literal notranslate"><span class="pre">sp</span></code> package. Fortunately, that is easy to convert: <code class="docutils literal notranslate"><span class="pre">as(sf_object,</span> <span class="pre">'Spatial')</span></code> does the trick.</p>
<p>We’ll rasterize the <code class="docutils literal notranslate"><span class="pre">uk_eire_BNG</span></code> vector data onto a 20km resolution grid. We will also use the <code class="docutils literal notranslate"><span class="pre">st_cast</span></code> function to change the polygon data into lines and points, to show the differences in the outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the target raster </span>
<span class="n">uk_20km</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">xmn</span><span class="o">=</span><span class="m">-200000</span><span class="p">,</span> <span class="n">xmx</span><span class="o">=</span><span class="m">650000</span><span class="p">,</span> <span class="n">ymn</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">ymx</span><span class="o">=</span><span class="m">1000000</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="m">20000</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&#39;+init=EPSG:27700&#39;</span><span class="p">)</span>

<span class="c1"># Rasterizing polygons</span>
<span class="n">uk_eire_poly_20km</span>  <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">uk_20km</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># Rasterizing lines</span>
<span class="n">uk_eire_BNG_line</span> <span class="o">&lt;-</span> <span class="nf">st_cast</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">,</span> <span class="s">&#39;LINESTRING&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in st_cast.sf(uk_eire_BNG, &quot;LINESTRING&quot;):
“repeating attributes for all sub-geometries for which they may not be constant”
</pre></div>
</div>
</div>
</div>
<p>One excellent feature of the <code class="docutils literal notranslate"><span class="pre">sf</span></code> package is the sheer quantity of warnings it will issue to avoid making errors. When you alter geometries, it isn’t always clear that the attributes of the original geometry apply to the altered geometries.  Here, we are being warned that the country attributes might not apply to the lines. We can use the <code class="docutils literal notranslate"><span class="pre">st_agr</span></code> function to tell <code class="docutils literal notranslate"><span class="pre">sf</span></code> that attributes <em>are</em> constant and it will stop warning us.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_BNG</span><span class="o">$</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="nf">as.factor</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="o">$</span><span class="n">name</span><span class="p">)</span>
<span class="nf">st_agr</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s">&#39;constant&#39;</span>

<span class="c1"># Rasterizing lines.</span>
<span class="n">uk_eire_BNG_line</span> <span class="o">&lt;-</span> <span class="nf">st_cast</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">,</span> <span class="s">&#39;LINESTRING&#39;</span><span class="p">)</span>
<span class="n">uk_eire_line_20km</span> <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">uk_eire_BNG_line</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">uk_20km</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># Rasterizing points </span>
<span class="c1"># - This isn&#39;t quite as neat. You need to take two steps in the cast and need to convert </span>
<span class="c1">#   the name factor to numeric.</span>
<span class="n">uk_eire_BNG_point</span> <span class="o">&lt;-</span> <span class="nf">st_cast</span><span class="p">(</span><span class="nf">st_cast</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">,</span> <span class="s">&#39;MULTIPOINT&#39;</span><span class="p">),</span> <span class="s">&#39;POINT&#39;</span><span class="p">)</span>
<span class="n">uk_eire_BNG_point</span><span class="o">$</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">uk_eire_BNG_point</span><span class="o">$</span><span class="n">name</span><span class="p">)</span>
<span class="n">uk_eire_point_20km</span> <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">uk_eire_BNG_point</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">uk_20km</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># Plotting those different outcomes</span>
<span class="c1"># - Use the hcl.colors function to create a nice plotting palette</span>
<span class="n">color_palette</span> <span class="o">&lt;-</span> <span class="nf">hcl.colors</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>

<span class="c1"># - Plot each raster</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_poly_20km</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_line_20km</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_point_20km</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_89_0.png" src="../_images/practical_1_89_0.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fasterize</span></code> package hugely speeds up <em>polygon</em> rasterization and is built to work with <code class="docutils literal notranslate"><span class="pre">sf</span></code>: <a class="reference external" href="https://github.com/ecohealthalliance/fasterize">https://github.com/ecohealthalliance/fasterize</a>. It doesn’t currently support point and line rasterization.</p>
</div>
<div class="section" id="raster-to-vector">
<h3>Raster to vector<a class="headerlink" href="#raster-to-vector" title="Permalink to this headline">¶</a></h3>
<p>A raster holds values in a regular grid. You can either view a value as representing the whole cell - in which case you might represent the cell as a polygon -  or a point in the centre - when you would use a point. The <code class="docutils literal notranslate"><span class="pre">raster</span></code> package provides functions to handle both of these. One extra feature for creating polygons is the <code class="docutils literal notranslate"><span class="pre">dissolve=TRUE</span></code> option but this requires the <code class="docutils literal notranslate"><span class="pre">rgeos</span></code> package to be installed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># rasterToPolygons returns a polygon for each cell and returns a Spatial object</span>
<span class="n">poly_from_rast</span> <span class="o">&lt;-</span> <span class="nf">rasterToPolygons</span><span class="p">(</span><span class="n">uk_eire_poly_20km</span><span class="p">)</span>
<span class="n">poly_from_rast</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">poly_from_rast</span><span class="p">,</span> <span class="s">&#39;sf&#39;</span><span class="p">)</span>

<span class="c1"># but can be set to dissolve the boundaries between cells with identical values</span>
<span class="n">poly_from_rast_dissolve</span> <span class="o">&lt;-</span> <span class="nf">rasterToPolygons</span><span class="p">(</span><span class="n">uk_eire_poly_20km</span><span class="p">,</span> <span class="n">dissolve</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">poly_from_rast_dissolve</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">poly_from_rast_dissolve</span><span class="p">,</span> <span class="s">&#39;sf&#39;</span><span class="p">)</span>

<span class="c1"># rasterToPoints returns a matrix of coordinates and values.</span>
<span class="n">points_from_rast</span> <span class="o">&lt;-</span> <span class="nf">rasterToPoints</span><span class="p">(</span><span class="n">uk_eire_poly_20km</span><span class="p">)</span>
<span class="n">points_from_rast</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">points_from_rast</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">))</span>

<span class="c1"># Plot the outputs - using key.pos=NULL to suppress the key and</span>
<span class="c1"># reset=FALSE to avoid plot.sf altering the par() options</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">poly_from_rast</span><span class="p">[</span><span class="s">&#39;layer&#39;</span><span class="p">],</span> <span class="n">key.pos</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">poly_from_rast_dissolve</span><span class="p">,</span> <span class="n">key.pos</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">points_from_rast</span><span class="p">,</span> <span class="n">key.pos</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_91_0.png" src="../_images/practical_1_91_0.png" />
</div>
</div>
<p>It is uncommon to have raster data representing linear features (like <code class="docutils literal notranslate"><span class="pre">uk_eire_line_20km</span></code>) and it is not trivial to turn raster data into LINESTRING vector data. We won’t look at this here.</p>
</div>
</div>
<div class="section" id="using-data-in-files">
<h2>Using data in files<a class="headerlink" href="#using-data-in-files" title="Permalink to this headline">¶</a></h2>
<p>There are a huge range of different formats for spatial data. Fortunately, the <code class="docutils literal notranslate"><span class="pre">sf</span></code> and <code class="docutils literal notranslate"><span class="pre">raster</span></code> packages make life easy: the <code class="docutils literal notranslate"><span class="pre">st_read</span></code> function in <code class="docutils literal notranslate"><span class="pre">sf</span></code> reads most vector data and the <code class="docutils literal notranslate"><span class="pre">raster</span></code> function in <code class="docutils literal notranslate"><span class="pre">raster</span></code> reads most raster formats. There are odd file formats that are harder to read but most are covered by these two packages. The two packages also provide functions to save data to a file.</p>
<div class="section" id="saving-vector-data">
<h3>Saving vector data<a class="headerlink" href="#saving-vector-data" title="Permalink to this headline">¶</a></h3>
<p>The most common vector data file format is the shapefile. This was developed by ESRI for use in ArcGIS but has become a common standard. We can save our <code class="docutils literal notranslate"><span class="pre">uk_eire</span></code> data to a shapfile using the <code class="docutils literal notranslate"><span class="pre">st_write</span></code> function from the <code class="docutils literal notranslate"><span class="pre">sf</span></code> package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_write</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="s">&#39;data/uk_eire_WGS84.shp&#39;</span><span class="p">)</span>
<span class="nf">st_write</span><span class="p">(</span><span class="n">uk_eire_BNG</span><span class="p">,</span> <span class="s">&#39;data/uk_eire_BNG.shp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing layer `uk_eire_WGS84&#39; to data source 
  `data/uk_eire_WGS84.shp&#39; using driver `ESRI Shapefile&#39;
Writing 6 features with 6 fields and geometry type Polygon.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing layer `uk_eire_BNG&#39; to data source 
  `data/uk_eire_BNG.shp&#39; using driver `ESRI Shapefile&#39;
Writing 6 features with 6 fields and geometry type Polygon.
</pre></div>
</div>
</div>
</div>
<p>If you look in the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory, you see an irritating feature of the shapefile format: <strong>a shapefile is not a single file</strong>. A shapefile consists of a set of files: they all have the same name but different file suffixes and you need (at least) the files ending with <code class="docutils literal notranslate"><span class="pre">.prj</span></code>, <code class="docutils literal notranslate"><span class="pre">.shp</span></code>, <code class="docutils literal notranslate"><span class="pre">.shx</span></code> and <code class="docutils literal notranslate"><span class="pre">.dbf</span></code>, which is what <code class="docutils literal notranslate"><span class="pre">st_write</span></code> has created.</p>
<p>Other file formats are increasingly commonly used in place of the shapefile. ArcGIS has moved towards the personal geodatabase but more portable options are:</p>
<ul class="simple">
<li><p>GeoJSON stores the coordinates and attributes in a single text file: it is <em>technically</em> human readable but you have to be familiar with JSON data structures.</p></li>
<li><p>GeoPackage stores vector data in a single SQLite3 database file. There are multiple tables inside this file holding various information about the data, but it is very portable and in a single file.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_write</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="s">&#39;data/uk_eire_WGS84.geojson&#39;</span><span class="p">)</span>
<span class="nf">st_write</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="s">&#39;data/uk_eire_WGS84.gpkg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing layer `uk_eire_WGS84&#39; to data source 
  `data/uk_eire_WGS84.geojson&#39; using driver `GeoJSON&#39;
Writing 6 features with 6 fields and geometry type Polygon.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing layer `uk_eire_WGS84&#39; to data source 
  `data/uk_eire_WGS84.gpkg&#39; using driver `GPKG&#39;
Writing 6 features with 6 fields and geometry type Polygon.
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sf</span></code> package will try and choose the output format based on the file suffix (so <code class="docutils literal notranslate"><span class="pre">.shp</span></code> gives ESRI Shapefile). If you don’t want to use the standard file suffix, you can also specify a <strong>driver</strong> directly: a driver is simply a bit of internal software that reads or writes a particular format and you can see the list of available formats using <code class="docutils literal notranslate"><span class="pre">st_drivers()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_write</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">,</span> <span class="s">&#39;data/uk_eire_WGS84.json&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s">&#39;GeoJSON&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing layer `uk_eire_WGS84&#39; to data source 
  `data/uk_eire_WGS84.json&#39; using driver `GeoJSON&#39;
Writing 6 features with 6 fields and geometry type Polygon.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="saving-raster-data">
<h3>Saving raster data<a class="headerlink" href="#saving-raster-data" title="Permalink to this headline">¶</a></h3>
<p>The GeoTIFF file format is one of the most common GIS raster data formats. It is basically the same as a TIFF image file but contains embedded data describing the origin, resolution and coordinate reference system of the data. Sometimes, you may also see a <code class="docutils literal notranslate"><span class="pre">.tfw</span></code> file: this is a ‘world’ file that contains the same information and you should probably keep it with the TIFF file.</p>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">writeRaster</span></code> function from the <code class="docutils literal notranslate"><span class="pre">raster</span></code> package to save our raster data. Again, the <code class="docutils literal notranslate"><span class="pre">raster</span></code> package will try and use the file name to choose a format but you can also use <code class="docutils literal notranslate"><span class="pre">format</span></code> to set the driver used to write the data: see <code class="docutils literal notranslate"><span class="pre">writeFormats()</span></code> for the options.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save a GeoTiff</span>
<span class="nf">writeRaster</span><span class="p">(</span><span class="n">uk_raster_BNG_interp</span><span class="p">,</span> <span class="s">&#39;data/uk_raster_BNG_interp.tif&#39;</span><span class="p">)</span>
<span class="c1"># Save an ASCII format file: human readable text. </span>
<span class="c1"># Note that this format does not contain the projection details!</span>
<span class="nf">writeRaster</span><span class="p">(</span><span class="n">uk_raster_BNG_ngb</span><span class="p">,</span> <span class="s">&#39;data/uk_raster_BNG_ngb.asc&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading-vector-data">
<h3>Loading Vector data<a class="headerlink" href="#loading-vector-data" title="Permalink to this headline">¶</a></h3>
<p>As an example here, we will use the 1:110m scale Natural Earth data on countries. The Natural Earth <a class="reference external" href="https://www.naturalearthdata.com/">website</a> is a great open-source repository for lots of basic GIS data. It also has a R package that provides access to the data (<a class="reference external" href="https://cran.r-project.org/web/packages/rnaturalearth/"><code class="docutils literal notranslate"><span class="pre">rnaturalearth</span></code></a>), but in practice downloading and saving the specific files you want isn’t that hard!</p>
<p>We wil also use some downloaded WHO data. You will be unsurprised to hear that there is an R package to access this data (<a class="reference external" href="https://cran.r-project.org/web/packages/WHO"><code class="docutils literal notranslate"><span class="pre">WHO</span></code></a>) but we’ll use a already downloaded copy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load a vector shapefile</span>
<span class="n">ne_110</span> <span class="o">&lt;-</span> <span class="nf">st_read</span><span class="p">(</span><span class="s">&#39;data/ne_110m_admin_0_countries/ne_110m_admin_0_countries.shp&#39;</span><span class="p">)</span>
<span class="c1"># Also load some WHO data on 2016 life expectancy</span>
<span class="c1"># see: http://apps.who.int/gho/athena/api/GHO/WHOSIS_000001?filter=YEAR:2016;SEX:BTSX&amp;format=csv</span>
<span class="n">life_exp</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&quot;data/WHOSIS_000001.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading layer `ne_110m_admin_0_countries&#39; from data source 
  `/Users/dorme/Teaching/GIS/Masters_GIS_2020/practicals/practical_1/data/ne_110m_admin_0_countries/ne_110m_admin_0_countries.shp&#39; 
  using driver `ESRI Shapefile&#39;
Simple feature collection with 177 features and 161 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
CRS:           4326
</pre></div>
</div>
</div>
</div>
<div class="admonition-create-some-global-maps admonition">
<p class="admonition-title">Create some global maps</p>
<p>Using the data loaded above, recreate the two plots shown below of global GDP and 2016 global life expectancy, averaged for both sexes. This only needs the plotting and merging skills from above.</p>
<p>The GDP data is already in the <code class="docutils literal notranslate"><span class="pre">ne_110</span></code> data, but you will need to add the life expectancy data to the GIS data. Getting country names to match between datasets is unexpectedly a common problem: try using the <code class="docutils literal notranslate"><span class="pre">ISO_A3_EH</span></code> field in <code class="docutils literal notranslate"><span class="pre">ne_110</span></code>. The other gotcha with merge is that, by default, the merge <strong>drops rows</strong> when there is no match. Here, it makes sense to use <code class="docutils literal notranslate"><span class="pre">all.x=TRUE</span></code> to retain all the countries: they will get NA values for the missing life expectancy.</p>
<p>The life expectancy plot has been altered to show less blocky colours in a nicer palette (<code class="docutils literal notranslate"><span class="pre">hcl.colors</span></code> uses the <code class="docutils literal notranslate"><span class="pre">viridis</span></code> palette by default). You will need to set the <code class="docutils literal notranslate"><span class="pre">breaks</span></code> and <code class="docutils literal notranslate"><span class="pre">pal</span></code> arguments to get this effect.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate two stacked plots with narrow margins</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>

<span class="c1"># The first plot is easy</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ne_110</span><span class="p">[</span><span class="s">&#39;GDP_MD_EST&#39;</span><span class="p">],</span>  <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Global GDP&#39;</span><span class="p">,</span> <span class="n">logz</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>

<span class="c1"># Then for the second we need to merge the data</span>
<span class="n">ne_110</span> <span class="o">&lt;-</span> <span class="nf">merge</span><span class="p">(</span><span class="n">ne_110</span><span class="p">,</span> <span class="n">life_exp</span><span class="p">,</span> <span class="n">by.x</span><span class="o">=</span><span class="s">&#39;ISO_A3_EH&#39;</span><span class="p">,</span> <span class="n">by.y</span><span class="o">=</span><span class="s">&#39;COUNTRY&#39;</span><span class="p">,</span> <span class="n">all.x</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># Create a sequence of break values to use for display</span>
<span class="n">bks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">50</span><span class="p">,</span> <span class="m">85</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">0.25</span><span class="p">)</span>
<span class="c1"># Plot the data</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ne_110</span><span class="p">[</span><span class="s">&#39;Numeric&#39;</span><span class="p">],</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Global 2016 Life Expectancy (Both sexes)&#39;</span><span class="p">,</span>
      <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="n">pal</span><span class="o">=</span><span class="n">hcl.colors</span><span class="p">,</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_105_0.png" src="../_images/practical_1_105_0.png" />
<img alt="../_images/practical_1_105_1.png" src="../_images/practical_1_105_1.png" />
</div>
</div>
</div>
<div class="section" id="loading-xy-data">
<h3>Loading XY data<a class="headerlink" href="#loading-xy-data" title="Permalink to this headline">¶</a></h3>
<p>We’ve looked at this case earlier, but one common source of vector data is a table with coordinates in it (either longitude and latitude for geographic coordinates or X and Y coordinates for a projected coordinate system). We will load some data like this and convert it into a proper <code class="docutils literal notranslate"><span class="pre">sf</span></code> object.  You do have to know the coordinate system!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in Southern Ocean example data</span>
<span class="n">so_data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&#39;data/Southern_Ocean.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">so_data</span><span class="p">)</span>
<span class="c1"># Convert the data frame to an sf object</span>
<span class="n">so_data</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">so_data</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;long&#39;</span><span class="p">,</span> <span class="s">&#39;lat&#39;</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">so_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 5</caption>
<thead>
	<tr><th></th><th scope=col>station</th><th scope=col>lat</th><th scope=col>long</th><th scope=col>krill_abun</th><th scope=col>chlorophyll</th></tr>
	<tr><th></th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 6</td><td>-59.90960</td><td>-53.03006</td><td> 0.000000</td><td>1.0459308</td></tr>
	<tr><th scope=row>2</th><td> 8</td><td>-58.51637</td><td>-51.25974</td><td> 0.000000</td><td>0.7963782</td></tr>
	<tr><th scope=row>3</th><td>10</td><td>-59.91357</td><td>-49.41599</td><td>15.451699</td><td>0.8696133</td></tr>
	<tr><th scope=row>4</th><td>12</td><td>-60.97059</td><td>-48.13545</td><td>58.635360</td><td>0.3670812</td></tr>
	<tr><th scope=row>5</th><td>16</td><td>-57.97091</td><td>-42.93436</td><td> 0.000000</td><td>0.9829019</td></tr>
	<tr><th scope=row>6</th><td>19</td><td>-55.20345</td><td>-41.32185</td><td> 1.606727</td><td>1.6252205</td></tr>
</tbody>
</table>
</div><div class="output text_html"><table>
<caption>A sf: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>station</th><th scope=col>krill_abun</th><th scope=col>chlorophyll</th><th scope=col>geometry</th></tr>
	<tr><th></th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;POINT [°]&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 6</td><td> 0.000000</td><td>1.0459308</td><td>POINT (-53.03006 -59.9096)</td></tr>
	<tr><th scope=row>2</th><td> 8</td><td> 0.000000</td><td>0.7963782</td><td>POINT (-51.25974 -58.51637)</td></tr>
	<tr><th scope=row>3</th><td>10</td><td>15.451699</td><td>0.8696133</td><td>POINT (-49.41599 -59.91357)</td></tr>
	<tr><th scope=row>4</th><td>12</td><td>58.635360</td><td>0.3670812</td><td>POINT (-48.13545 -60.97059)</td></tr>
	<tr><th scope=row>5</th><td>16</td><td> 0.000000</td><td>0.9829019</td><td>POINT (-42.93436 -57.97091)</td></tr>
	<tr><th scope=row>6</th><td>19</td><td> 1.606727</td><td>1.6252205</td><td>POINT (-41.32185 -55.20345)</td></tr>
</tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="loading-raster-data">
<h3>Loading Raster data<a class="headerlink" href="#loading-raster-data" title="Permalink to this headline">¶</a></h3>
<p>We will look at some global topographic data taken from  the <a class="reference external" href="https://www.ngdc.noaa.gov/mgg/global/">ETOPO1</a> dataset. The original data is at 1 arc minute (1/60°) and this file has been resampled to 15 arc minutes (0.25°) to make it a bit more manageable (466.7Mb to 2.7 Mb).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">etopo_25</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/etopo_25.tif&#39;</span><span class="p">)</span>
<span class="c1"># Look at the data content</span>
<span class="nf">print</span><span class="p">(</span><span class="n">etopo_25</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">etopo_25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterLayer 
dimensions : 720, 1440, 1036800  (nrow, ncol, ncell)
resolution : 0.25, 0.25  (x, y)
extent     : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
source     : etopo_25.tif 
names      : etopo_25 
values     : -9295.364, 5930.763  (min, max)
</pre></div>
</div>
<img alt="../_images/practical_1_109_1.png" src="../_images/practical_1_109_1.png" />
</div>
</div>
<div class="admonition-controlling-raster-plots admonition">
<p class="admonition-title">Controlling raster plots</p>
<p>That isn’t a particularly useful colour scheme. Can you work out how to create the plot below? Some hints: you’ll need to set breaks again and then provide two colour palettes that match the values either side of 0. The function <code class="docutils literal notranslate"><span class="pre">colorRampPalette</span></code> is really helpful here, or you could use the built-in palettes.</p>
<p>You will also need to set the values that get labelled and their labels and this isn’t obvious. It needs to be set in the plot command like this:</p>
</div>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">axis.args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-10000</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">6000</span><span class="p">),</span> <span class="n">lab</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">6</span><span class="p">))</span>
</pre></div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">bks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-10000</span><span class="p">,</span> <span class="m">6000</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">250</span><span class="p">)</span>
<span class="n">land_cols</span>  <span class="o">&lt;-</span> <span class="nf">terrain.colors</span><span class="p">(</span><span class="m">24</span><span class="p">)</span>
<span class="n">sea_pal</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;darkslateblue&#39;</span><span class="p">,</span> <span class="s">&#39;steelblue&#39;</span><span class="p">,</span> <span class="s">&#39;paleturquoise&#39;</span><span class="p">))</span>
<span class="n">sea_cols</span> <span class="o">&lt;-</span> <span class="nf">sea_pal</span><span class="p">(</span><span class="m">40</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">etopo_25</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">sea_cols</span><span class="p">,</span> <span class="n">land_cols</span><span class="p">),</span> 
     <span class="n">axis.args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">-10000</span><span class="p">,</span> <span class="m">6000</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">2000</span><span class="p">),</span> <span class="n">lab</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="m">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_111_0.png" src="../_images/practical_1_111_0.png" />
</div>
</div>
</div>
<div class="section" id="raster-stacks">
<h3>Raster Stacks<a class="headerlink" href="#raster-stacks" title="Permalink to this headline">¶</a></h3>
<p>Raster data very often has multiple <strong>bands</strong>: a single file can contain multiple layers of information for the cells in the raster grid. An obvious example is colour imagery, where three layers hold red, green and blue values, but satellite data can contain many layers holding different bands.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">getData</span></code> function from the <code class="docutils literal notranslate"><span class="pre">raster</span></code> library to get at another example. This function loads data from some key data repositories (see <code class="docutils literal notranslate"><span class="pre">?getData</span></code> ). It will download the data automatically if needed and store it locally. Note that you only need to download the data once - as long as you tell <code class="docutils literal notranslate"><span class="pre">getData</span></code> where the files were stored, it will note that you have a local copy and load those, although it would be more usual just to use <code class="docutils literal notranslate"><span class="pre">raster</span></code> at this point! This data has already been downloaded to the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory - <code class="docutils literal notranslate"><span class="pre">getData</span></code> will load it from the <code class="docutils literal notranslate"><span class="pre">data/wc10</span></code> folder.</p>
<p>We’ll look at some worldclim data (<a class="reference external" href="http://worldclim.org/version2">http://worldclim.org/version2</a>) for maximum temperature, which comes as a stack of monthly values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download bioclim data: global maximum temperature at 10 arc minute resolution</span>
<span class="n">tmax</span> <span class="o">&lt;-</span> <span class="nf">getData</span><span class="p">(</span><span class="s">&#39;worldclim&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s">&#39;tmax&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="m">10</span><span class="p">)</span>
<span class="c1"># The data has 12 layers, one for each month</span>
<span class="nf">print</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterStack 
dimensions : 900, 2160, 1944000, 12  (nrow, ncol, ncell, nlayers)
resolution : 0.1666667, 0.1666667  (x, y)
extent     : -180, 180, -60, 90  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
names      : tmax1, tmax2, tmax3, tmax4, tmax5, tmax6, tmax7, tmax8, tmax9, tmax10, tmax11, tmax12 
min values :  -478,  -421,  -422,  -335,  -190,   -94,   -59,   -76,  -153,   -265,   -373,   -452 
max values :   418,   414,   420,   429,   441,   467,   489,   474,   441,    401,    401,    413 
</pre></div>
</div>
</div>
</div>
<p>One odd thing about that data is the range of values: <code class="docutils literal notranslate"><span class="pre">-478</span></code> to <code class="docutils literal notranslate"><span class="pre">489</span></code>. It is <em>really common</em> for GIS data to be stored in a form that needs scaling by the end user and this is what is going on here. The metadata for a raster data set should include any scale and offset values needed but you need to check that any variables you use are correctly scaled.</p>
<p>The reason to do this is to minimise disk use: <code class="docutils literal notranslate"><span class="pre">-478</span></code> to <code class="docutils literal notranslate"><span class="pre">489</span></code> can be stored really easily as integer data with 2 bytes per number (<code class="docutils literal notranslate"><span class="pre">Int16</span></code>). If it was stored as float data (with a decimal point), it would be 4 bytes per number (<code class="docutils literal notranslate"><span class="pre">Float32</span></code>) or worse (<code class="docutils literal notranslate"><span class="pre">Float64</span></code>).  So, the data file is half the size and - since the data is only accurate to 1 decimal place - we have no loss of precision.</p>
<p>We can access different layers using <code class="docutils literal notranslate"><span class="pre">[[</span></code>. We can also use aggregate functions (like <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">mean</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">min</span></code>) to extract information across layers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># scale the data</span>
<span class="n">tmax</span> <span class="o">&lt;-</span> <span class="n">tmax</span> <span class="o">/</span> <span class="m">10</span>
<span class="c1"># Extract  January and July data and the annual maximum by location.</span>
<span class="n">tmax_jan</span> <span class="o">&lt;-</span> <span class="n">tmax</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span>
<span class="n">tmax_jul</span> <span class="o">&lt;-</span> <span class="n">tmax</span><span class="p">[[</span><span class="m">7</span><span class="p">]]</span>
<span class="n">tmax_max</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
<span class="c1"># Plot those maps</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="n">bks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-50</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">101</span><span class="p">)</span>
<span class="n">pal</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;lightblue&#39;</span><span class="p">,</span><span class="s">&#39;grey&#39;</span><span class="p">,</span> <span class="s">&#39;firebrick&#39;</span><span class="p">))</span>
<span class="n">cols</span> <span class="o">&lt;-</span> <span class="nf">pal</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="n">ax.args</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-50</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">100</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">tmax_jan</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="n">ax.args</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;January maximum temperature&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">tmax_jul</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="n">ax.args</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;July maximum temperature&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">tmax_max</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="n">ax.args</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Annual maximum temperature&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_115_0.png" src="../_images/practical_1_115_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="overlaying-raster-and-vector-data">
<h2>Overlaying raster and vector data<a class="headerlink" href="#overlaying-raster-and-vector-data" title="Permalink to this headline">¶</a></h2>
<p>In this next exercise, we are going to use some data to build up a more complex map of chlorophyll concentrations in the Southern Ocean. There are a few new techniques along the way.</p>
<div class="section" id="cropping-data">
<h3>Cropping data<a class="headerlink" href="#cropping-data" title="Permalink to this headline">¶</a></h3>
<p>Sometimes you are only interested in a subset of the area covered by a GIS dataset. Cropping the data to the area of interest can make plotting easier and can also make GIS operations a lot faster, particularly if the data is complex.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">so_extent</span> <span class="o">&lt;-</span> <span class="nf">extent</span><span class="p">(</span><span class="m">-60</span><span class="p">,</span> <span class="m">-20</span><span class="p">,</span> <span class="m">-65</span><span class="p">,</span> <span class="m">-45</span><span class="p">)</span>
<span class="c1"># The crop function for raster data...</span>
<span class="n">so_topo</span> <span class="o">&lt;-</span> <span class="nf">crop</span><span class="p">(</span><span class="n">etopo_25</span><span class="p">,</span> <span class="n">so_extent</span><span class="p">)</span>
<span class="c1"># ... and the st_crop function to reduce some higher resolution coastline data</span>
<span class="n">ne_10</span> <span class="o">&lt;-</span> <span class="nf">st_read</span><span class="p">(</span><span class="s">&#39;data/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp&#39;</span><span class="p">)</span>
<span class="nf">st_agr</span><span class="p">(</span><span class="n">ne_10</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s">&#39;constant&#39;</span>
<span class="n">so_ne_10</span> <span class="o">&lt;-</span> <span class="nf">st_crop</span><span class="p">(</span><span class="n">ne_10</span><span class="p">,</span> <span class="n">so_extent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading layer `ne_10m_admin_0_countries&#39; from data source 
  `/Users/dorme/Teaching/GIS/Masters_GIS_2020/practicals/practical_1/data/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp&#39; 
  using driver `ESRI Shapefile&#39;
Simple feature collection with 255 features and 94 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.6341
CRS:           4326
</pre></div>
</div>
</div>
</div>
<div class="admonition-plotting-southern-ocean-chlorophyll admonition">
<p class="admonition-title">Plotting Southern Ocean chlorophyll</p>
<p>Using the data loaded above, recreate this map. For continuous raster data, contours can help make the data a bit clearer or replace a legend and are easy to add using the <code class="docutils literal notranslate"><span class="pre">contour</span></code> function with a raster object.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sea_pal</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;grey30&#39;</span><span class="p">,</span> <span class="s">&#39;grey50&#39;</span><span class="p">,</span> <span class="s">&#39;grey70&#39;</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">so_topo</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nf">sea_pal</span><span class="p">(</span><span class="m">100</span><span class="p">),</span> <span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">contour</span><span class="p">(</span><span class="n">so_topo</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-2000</span><span class="p">,</span> <span class="m">-4000</span><span class="p">,</span> <span class="m">-6000</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;grey80&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">so_ne_10</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;grey90&#39;</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey40&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">so_data</span><span class="p">[</span><span class="s">&#39;chlorophyll&#39;</span><span class="p">],</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">logz</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">pal</span><span class="o">=</span><span class="n">hcl.colors</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">.image_scale</span><span class="p">(</span><span class="nf">log10</span><span class="p">(</span><span class="n">so_data</span><span class="o">$</span><span class="n">chlorophyll</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="nf">hcl.colors</span><span class="p">(</span><span class="m">18</span><span class="p">),</span> <span class="n">key.length</span><span class="o">=</span><span class="m">0.8</span><span class="p">,</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">logz</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_119_0.png" src="../_images/practical_1_119_0.png" />
<img alt="../_images/practical_1_119_1.png" src="../_images/practical_1_119_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="spatial-joins-and-raster-data-extraction">
<h2>Spatial joins and raster data extraction<a class="headerlink" href="#spatial-joins-and-raster-data-extraction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="spatial-joining">
<h3>Spatial joining<a class="headerlink" href="#spatial-joining" title="Permalink to this headline">¶</a></h3>
<p>We have merged data into an <code class="docutils literal notranslate"><span class="pre">sf</span></code> object by matching values in columns, but we can also merge data <strong>spatially</strong>. This process is often called a <strong>spatial join</strong>.</p>
<p>As an example, we are going to look at mapping ‘mosquito outbreaks’ in Africa: we are actually going to use some random data, mostly to demonstrate the useful <code class="docutils literal notranslate"><span class="pre">st_sample</span></code> function. We would like to find out whether any countries are more severely impacted in terms of both the area of the country and their population size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="c1"># extract Africa from the ne_110 data and keep the columns we want to use</span>
<span class="n">africa</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">ne_110</span><span class="p">,</span> <span class="n">CONTINENT</span><span class="o">==</span><span class="s">&#39;Africa&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;ADMIN&#39;</span><span class="p">,</span> <span class="s">&#39;POP_EST&#39;</span><span class="p">))</span>

<span class="c1"># transform to the Robinson projection</span>
<span class="n">africa</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">africa</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">54030</span><span class="p">)</span>
<span class="c1"># create a random sample of points</span>
<span class="n">mosquito_points</span> <span class="o">&lt;-</span> <span class="nf">st_sample</span><span class="p">(</span><span class="n">africa</span><span class="p">,</span> <span class="m">1000</span><span class="p">)</span>

<span class="c1"># Create the plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">africa</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;khaki&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">mosquito_points</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;firebrick&#39;</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_121_0.png" src="../_images/practical_1_121_0.png" />
</div>
</div>
<p>In order to join these data together we need to turn the <code class="docutils literal notranslate"><span class="pre">mosquito_points</span></code> object from a geometry column (<code class="docutils literal notranslate"><span class="pre">sfc</span></code>) into a full <code class="docutils literal notranslate"><span class="pre">sf</span></code> data frame, so it can have attributes and then we can simply add the country name (‘ADMIN’) onto the points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mosquito_points</span> <span class="o">&lt;-</span> <span class="nf">st_sf</span><span class="p">(</span><span class="n">mosquito_points</span><span class="p">)</span>
<span class="n">mosquito_points</span> <span class="o">&lt;-</span> <span class="nf">st_join</span><span class="p">(</span><span class="n">mosquito_points</span><span class="p">,</span> <span class="n">africa</span><span class="p">[</span><span class="s">&#39;ADMIN&#39;</span><span class="p">])</span>

<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">africa</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;khaki&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">mosquito_points</span><span class="p">[</span><span class="s">&#39;ADMIN&#39;</span><span class="p">],</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_123_0.png" src="../_images/practical_1_123_0.png" />
</div>
</div>
<p>We can now aggregate the points within countries. This can give us a count of the number of points in each country and also converts multiple rows of <code class="docutils literal notranslate"><span class="pre">POINT</span></code> into a single <code class="docutils literal notranslate"><span class="pre">MULTIPOINT</span></code> feature per country.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mosquito_points_agg</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">mosquito_points</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">mosquito_points</span><span class="o">$</span><span class="n">ADMIN</span><span class="p">),</span> <span class="n">FUN</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">mosquito_points_agg</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="o">&lt;-</span><span class="s">&#39;n_outbreaks&#39;</span>
<span class="nf">head</span><span class="p">(</span><span class="n">mosquito_points_agg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A sf: 6 × 3</caption>
<thead>
	<tr><th></th><th scope=col>country</th><th scope=col>n_outbreaks</th><th scope=col>geometry</th></tr>
	<tr><th></th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;GEOMETRY [m]&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>Algeria     </td><td>91</td><td>MULTIPOINT ((-682422.1 2972...</td></tr>
	<tr><th scope=row>2</th><td>Angola      </td><td>41</td><td>MULTIPOINT ((1133960 -56731...</td></tr>
	<tr><th scope=row>3</th><td>Benin       </td><td> 1</td><td>POINT (236471.4 903118.7)</td></tr>
	<tr><th scope=row>4</th><td>Botswana    </td><td>12</td><td>MULTIPOINT ((1943318 -26749...</td></tr>
	<tr><th scope=row>5</th><td>Burkina Faso</td><td> 7</td><td>MULTIPOINT ((-415457.6 1238...</td></tr>
	<tr><th scope=row>6</th><td>Burundi     </td><td> 1</td><td>POINT (2768345 -393948.5)</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">africa</span> <span class="o">&lt;-</span> <span class="nf">st_join</span><span class="p">(</span><span class="n">africa</span><span class="p">,</span> <span class="n">mosquito_points_agg</span><span class="p">)</span>
<span class="n">africa</span><span class="o">$</span><span class="n">area</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">st_area</span><span class="p">(</span><span class="n">africa</span><span class="p">))</span>
<span class="nf">head</span><span class="p">(</span><span class="n">africa</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A sf: 6 × 6</caption>
<thead>
	<tr><th></th><th scope=col>ADMIN</th><th scope=col>POP_EST</th><th scope=col>country</th><th scope=col>n_outbreaks</th><th scope=col>geometry</th><th scope=col>area</th></tr>
	<tr><th></th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;MULTIPOLYGON [m]&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>2</th><td>Somaliland  </td><td> 3500000</td><td>Somaliland  </td><td> 5</td><td>MULTIPOLYGON (((4597353 122...</td><td>1.388201e+11</td></tr>
	<tr><th scope=row>5</th><td>Angola      </td><td>29310273</td><td>Angola      </td><td>41</td><td>MULTIPOLYGON (((1226185 -51...</td><td>1.039192e+12</td></tr>
	<tr><th scope=row>15</th><td>Burundi     </td><td>11466756</td><td>Burundi     </td><td> 1</td><td>MULTIPOLYGON (((2877605 -25...</td><td>2.156439e+10</td></tr>
	<tr><th scope=row>17</th><td>Benin       </td><td>11038805</td><td>Benin       </td><td> 1</td><td>MULTIPOLYGON (((253782.4 66...</td><td>9.698961e+10</td></tr>
	<tr><th scope=row>18</th><td>Burkina Faso</td><td>20107509</td><td>Burkina Faso</td><td> 7</td><td>MULTIPOLYGON (((-508076 110...</td><td>2.265447e+11</td></tr>
	<tr><th scope=row>29</th><td>Botswana    </td><td> 2214858</td><td>Botswana    </td><td>12</td><td>MULTIPOLYGON (((2721227 -23...</td><td>5.125633e+11</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mgp</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">n_outbreaks</span> <span class="o">~</span> <span class="n">POP_EST</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">africa</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s">&#39;xy&#39;</span><span class="p">,</span> 
     <span class="n">ylab</span><span class="o">=</span><span class="s">&#39;Number of outbreaks&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&#39;Population size&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">n_outbreaks</span> <span class="o">~</span> <span class="n">area</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">africa</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s">&#39;xy&#39;</span><span class="p">,</span>
     <span class="n">ylab</span><span class="o">=</span><span class="s">&#39;Number of outbreaks&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&#39;Area (m2)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_127_0.png" src="../_images/practical_1_127_0.png" />
</div>
</div>
<div class="admonition-alien-invasion admonition">
<p class="admonition-title">Alien invasion</p>
<p>Martians have invaded! Jeff and Will have managed to steal the landing sites and the crew sizes from the alien mothership but we need to work out which countries are going to be overwhelmed by aliens. We think that countries with more than about 1000 people per alien are going to be ok, but we need a map of alien threat like the one below. The landing sites are in the file <code class="docutils literal notranslate"><span class="pre">data/aliens.csv</span></code> as WGS84 coordinates.</p>
<p>Can you produce our plan?</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is a hack! (2021-11-01)</span>
<span class="nf">sf_use_s2</span><span class="p">(</span><span class="kc">FALSE</span><span class="p">)</span>

<span class="c1"># Load the data and convert to a sf object</span>
<span class="n">alien_xy</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&#39;data/aliens.csv&#39;</span><span class="p">)</span>
<span class="n">alien_xy</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">alien_xy</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;long&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>

<span class="c1"># Add country information and find the total number of aliens per country</span>
<span class="n">alien_xy</span> <span class="o">&lt;-</span> <span class="nf">st_join</span><span class="p">(</span><span class="n">alien_xy</span><span class="p">,</span> <span class="n">ne_110</span><span class="p">)</span>
<span class="n">aliens_by_country</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">n_aliens</span> <span class="o">~</span> <span class="n">ADMIN</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">alien_xy</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="n">sum</span><span class="p">)</span>

<span class="c1"># Add the alien counts into the country data </span>
<span class="n">ne_110</span> <span class="o">&lt;-</span> <span class="nf">merge</span><span class="p">(</span><span class="n">ne_110</span><span class="p">,</span> <span class="n">aliens_by_country</span><span class="p">,</span> <span class="n">all.x</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">ne_110</span><span class="o">$</span><span class="n">aliens_per_capita</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">ne_110</span><span class="p">,</span>  <span class="n">n_aliens</span> <span class="o">/</span> <span class="n">POP_EST</span><span class="p">)</span>

<span class="c1"># create the scale colours</span>
<span class="n">bks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-8</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">101</span><span class="p">)</span>
<span class="n">pal</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;darkblue&#39;</span><span class="p">,</span><span class="s">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s">&#39;salmon&#39;</span><span class="p">,</span><span class="s">&#39;darkred&#39;</span><span class="p">))</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">ne_110</span><span class="p">[</span><span class="s">&#39;aliens_per_capita&#39;</span><span class="p">],</span> <span class="n">logz</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">bks</span><span class="p">,</span> <span class="n">pal</span><span class="o">=</span><span class="n">pal</span><span class="p">,</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Spherical geometry (s2) switched off
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>although coordinates are longitude/latitude, st_intersects assumes that they are planar
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>although coordinates are longitude/latitude, st_intersects assumes that they are planar
</pre></div>
</div>
<img alt="../_images/practical_1_129_3.png" src="../_images/practical_1_129_3.png" />
</div>
</div>
</div>
<div class="section" id="extracting-data-from-rasters">
<h3>Extracting data from Rasters<a class="headerlink" href="#extracting-data-from-rasters" title="Permalink to this headline">¶</a></h3>
<p>The spatial join above allows us to connect vector data based on location but you might also need to extract data from a raster dataset in certain locations. Examples include to know the
exact altitude or surface temperature of sampling sites or average values within a polygon. We are going to use a chunk of the full resolution ETOPO1 elevation data to explore this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_etopo</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/etopo_uk.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-masking-elevation-data admonition">
<p class="admonition-title">Masking elevation data</p>
<p>Before we can do this, ETOPO data include bathymetry as well as elevation. Use the <code class="docutils literal notranslate"><span class="pre">rasterize</span></code> function on the high resolution <code class="docutils literal notranslate"><span class="pre">ne_10</span></code> dataset to get a land raster matching <code class="docutils literal notranslate"><span class="pre">uk_eire_etopo</span></code> and then use the <code class="docutils literal notranslate"><span class="pre">mask</span></code> function to create the elevation map. You should end up with the following data.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_detail</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">ne_10</span><span class="p">,</span> <span class="n">ADMIN</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;United Kingdom&#39;</span><span class="p">,</span> <span class="s">&quot;Ireland&quot;</span><span class="p">))</span>
<span class="n">uk_eire_detail_raster</span> <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">uk_eire_detail</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">uk_eire_etopo</span><span class="p">)</span>
<span class="n">uk_eire_elev</span> <span class="o">&lt;-</span> <span class="nf">mask</span><span class="p">(</span><span class="n">uk_eire_etopo</span><span class="p">,</span> <span class="n">uk_eire_detail_raster</span><span class="p">)</span>

<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mgp</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_etopo</span><span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">las</span><span class="o">=</span><span class="m">3</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">las</span><span class="o">=</span><span class="m">3</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">uk_eire_detail</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_133_0.png" src="../_images/practical_1_133_0.png" />
</div>
</div>
</div>
<div class="section" id="raster-cell-statistics-and-locations">
<h3>Raster cell statistics and locations<a class="headerlink" href="#raster-cell-statistics-and-locations" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">cellStats</span></code> function provides a way summarize the data in a raster. We can also find out the locations of cells with particular characteristics using, for example, <code class="docutils literal notranslate"><span class="pre">Which</span></code> (note the capital letter!) and <code class="docutils literal notranslate"><span class="pre">which.max</span></code>. Both of those functions return cell ID numbers, but the <code class="docutils literal notranslate"><span class="pre">xyFromCell</span></code> allows you to turn those ID numbers into coordinates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">cellStats</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span>
<span class="nf">cellStats</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
<span class="c1"># Which is the highest cell</span>
<span class="nf">which.max</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">1195</div><div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>0%</dt><dd>-64</dd><dt>25%</dt><dd>53</dd><dt>50%</dt><dd>104</dd><dt>75%</dt><dd>204</dd><dt>100%</dt><dd>1195</dd></dl>
</div><div class="output text_html">113536</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Which cells are above 1100m</span>
<span class="nf">Which</span><span class="p">(</span><span class="n">uk_eire_elev</span> <span class="o">&gt;</span> <span class="m">1100</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>111980</li><li>111981</li><li>112761</li><li>112771</li><li>113536</li><li>113541</li><li>114318</li></ol>
</div></div>
</div>
<div class="admonition-highlight-highest-point-and-areas-below-sea-level admonition">
<p class="admonition-title">Highlight highest point and areas below sea level</p>
<p>Plot the locations of the maximum altitude and cells below sea level on the map. Some questions about the result:</p>
<ul class="simple">
<li><p>Is the maximum altitude the <em>real</em> maximum altitude in the UK? If not, why not?</p></li>
<li><p>Why do so many points have elevations below sea level? There are two reasons!</p></li>
</ul>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">max_cell</span> <span class="o">&lt;-</span> <span class="nf">which.max</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">)</span>
<span class="n">max_xy</span> <span class="o">&lt;-</span> <span class="nf">xyFromCell</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">max_cell</span><span class="p">)</span>
<span class="n">max_sfc</span><span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="nf">st_point</span><span class="p">(</span><span class="n">max_xy</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="n">bsl_cell</span> <span class="o">&lt;-</span> <span class="nf">Which</span><span class="p">(</span><span class="n">uk_eire_elev</span> <span class="o">&lt;</span> <span class="m">0</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">bsl_xy</span> <span class="o">&lt;-</span> <span class="nf">xyFromCell</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">bsl_cell</span><span class="p">)</span>
<span class="n">bsl_sfc</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="nf">st_multipoint</span><span class="p">(</span><span class="n">bsl_xy</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">axis.args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">las</span><span class="o">=</span><span class="m">3</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">max_sfc</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">24</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">bsl_sfc</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">25</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_138_0.png" src="../_images/practical_1_138_0.png" />
</div>
</div>
</div>
<div class="section" id="the-extract-function">
<h3>The extract function<a class="headerlink" href="#the-extract-function" title="Permalink to this headline">¶</a></h3>
<p>The previous section shows the basic functions needed to get at raster data but the <code class="docutils literal notranslate"><span class="pre">extract</span></code> function makes it easier. It works in different ways on different geometry types:</p>
<ul class="simple">
<li><p>POINT: extract the values under the points.</p></li>
<li><p>LINESTRING: extract the values under the linestring</p></li>
<li><p>POLYGON: extract the values within the polygon</p></li>
</ul>
<p>Extracting raster values under points is really easy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">uk_eire_capitals</span><span class="o">$</span><span class="n">elev</span> <span class="o">&lt;-</span> <span class="nf">extract</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">uk_eire_capitals</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire_capitals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 5 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -6.25 ymin: 51.5 xmax: -0.1 ymax: 55.8
CRS:           EPSG:4326
       name           geometry elev
1    London  POINT (-0.1 51.5)    8
2   Cardiff  POINT (-3.2 51.5)   21
3 Edinburgh  POINT (-3.2 55.8)  279
4   Belfast    POINT (-6 54.6)  269
5    Dublin POINT (-6.25 53.3)   43
</pre></div>
</div>
</div>
</div>
<p>Polygons are also easy but there is a little more detail about the output. By default, the <code class="docutils literal notranslate"><span class="pre">extract</span></code> function for polygons returns a set of <em>all</em> the raster values within each polygon. However, you can use the <code class="docutils literal notranslate"><span class="pre">fun</span></code> argument to specify that <code class="docutils literal notranslate"><span class="pre">extract</span></code> does something with those values. This  effectively duplicates the extremely useful <strong>Zonal Statistics</strong> function from other GIS programs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
<span class="n">uk_eire</span><span class="o">$</span><span class="n">mean_height</span> <span class="o">&lt;-</span> <span class="nf">extract</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">uk_eire</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">uk_eire</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterLayer 
dimensions : 600, 780, 468000  (nrow, ncol, ncell)
resolution : 0.01666667, 0.01666667  (x, y)
extent     : -11.00833, 1.991667, 49.49167, 59.49167  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
source     : memory
names      : etopo_uk 
values     : -64, 1195  (min, max)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 6 fields
Attribute-geometry relationship: 3 constant, 0 aggregate, 0 identity, 3 NA&#39;s
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name   capital n_km2                       geometry
1             Eire    Dublin    NA POLYGON ((-10 51.5, -10 54....
2          England    London   260 POLYGON ((-2 55.8, 0.5 52.8...
3           London      &lt;NA&gt;  4500 POLYGON ((0.151944 51.51361...
4 Northern Ireland   Belfast   133 POLYGON ((-6.91875 55.3, -5...
5         Scotland Edinburgh    67 POLYGON ((-5 58.6, -3 58.6,...
6            Wales   Cardiff   151 POLYGON ((-2.942105 51.3789...
               area    length log_n_km2
1  80224.782 [km^2] 1324.1192        NA
2 125488.900 [km^2] 2058.7893  2.414973
3   1510.155 [km^2]  143.5915  3.653213
4  13595.480 [km^2]  479.8911  2.123852
5  75904.871 [km^2] 1252.7360  1.826075
6  28834.611 [km^2]  688.6149  2.178977
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 6 features and 7 fields
Attribute-geometry relationship: 3 constant, 0 aggregate, 0 identity, 4 NA&#39;s
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10 ymin: 50 xmax: 1.6 ymax: 58.6
CRS:           EPSG:4326
              name   capital n_km2                       geometry
1             Eire    Dublin    NA POLYGON ((-10 51.5, -10 54....
2          England    London   260 POLYGON ((-2 55.8, 0.5 52.8...
3           London      &lt;NA&gt;  4500 POLYGON ((0.151944 51.51361...
4 Northern Ireland   Belfast   133 POLYGON ((-6.91875 55.3, -5...
5         Scotland Edinburgh    67 POLYGON ((-5 58.6, -3 58.6,...
6            Wales   Cardiff   151 POLYGON ((-2.942105 51.3789...
               area    length log_n_km2 mean_height
1  80224.782 [km^2] 1324.1192        NA   108.64256
2 125488.900 [km^2] 2058.7893  2.414973   110.57183
3   1510.155 [km^2]  143.5915  3.653213    57.20426
4  13595.480 [km^2]  479.8911  2.123852   125.03498
5  75904.871 [km^2] 1252.7360  1.826075   270.21158
6  28834.611 [km^2]  688.6149  2.178977   218.65102
</pre></div>
</div>
</div>
</div>
<p>Extracting values under linestrings is more complicated. The basic option works in the same way - the function returns the values underneath the line. If you want to tie the values to locations on the line then you need to work a bit harder:</p>
<ul class="simple">
<li><p>By default, the function just gives the sample of values under the line, in no particular order. The <code class="docutils literal notranslate"><span class="pre">along=TRUE</span></code> argument preserves the order along the line.</p></li>
<li><p>It is also useful to able to know <em>which</em> cell gives each value. The <code class="docutils literal notranslate"><span class="pre">cellnumbers=TRUE</span></code> argument allow us to retrieve this information.</p></li>
</ul>
<p>We are going to get a elevation transect for the <a class="reference external" href="https://www.nationaltrail.co.uk/pennine-way">Pennine Way</a>: a 429 km trail across some of the wildest bits of England. The data for the trail comes as a GPX file, commonly used in GPS receivers.</p>
<p>One feature of GPX files is that they contain multiple <strong>layers</strong>: essentially different GIS datasets within a single source. The <code class="docutils literal notranslate"><span class="pre">st_layers</span></code> function allows us to see the names of those layers so we can load the one we want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">st_layers</span><span class="p">(</span><span class="s">&#39;data/National_Trails_Pennine_Way.gpx&#39;</span><span class="p">)</span>
<span class="c1"># load the data, showing off the ability to use SQL queries to load subsets of the data</span>
<span class="n">pennine_way</span> <span class="o">&lt;-</span> <span class="nf">st_read</span><span class="p">(</span><span class="s">&#39;data/National_Trails_Pennine_Way.gpx&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s">&#39;routes&#39;</span><span class="p">,</span> 
                      <span class="n">query</span><span class="o">=</span><span class="s">&quot;select * from routes where name=&#39;Pennine Way&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Driver: GPX 
Available layers:
    layer_name     geometry_type features fields
1    waypoints             Point        0     23
2       routes       Line String        5     12
3       tracks Multi Line String        0     12
4 route_points             Point    10971     25
5 track_points             Point        0     26
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading layer `routes&#39; from data source 
  `/Users/dorme/Teaching/GIS/Masters_GIS_2020/practicals/practical_1/data/National_Trails_Pennine_Way.gpx&#39; 
  using driver `GPX&#39;
Simple feature collection with 1 feature and 12 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -2.562267 ymin: 53.36435 xmax: -1.816825 ymax: 55.54717
CRS:           4326
</pre></div>
</div>
</div>
</div>
<p>Before we do anything else, all of our data (<code class="docutils literal notranslate"><span class="pre">etopo_uk</span></code> and <code class="docutils literal notranslate"><span class="pre">pennine_way</span></code>) are in WGS84. It really does not make sense to calculate distances and transects on a geographic coordinate system so:</p>
<div class="admonition-reproject-the-penine-way admonition">
<p class="admonition-title">Reproject the Penine Way</p>
<p>Create <code class="docutils literal notranslate"><span class="pre">uk_eire_elev_BNG</span></code> and <code class="docutils literal notranslate"><span class="pre">pennine_way_BNG</span></code> by reprojecting the elevation raster and route vector into the British National Grid. Use a 2km resolution grid.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># reproject the vector data</span>
<span class="n">pennine_way_BNG</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">pennine_way</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">27700</span><span class="p">)</span>
<span class="c1"># create the target raster and project the elevation data into it.</span>
<span class="n">bng_2km</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">xmn</span><span class="o">=</span><span class="m">-200000</span><span class="p">,</span> <span class="n">xmx</span><span class="o">=</span><span class="m">700000</span><span class="p">,</span> <span class="n">ymn</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">ymx</span><span class="o">=</span><span class="m">1000000</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="m">2000</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&#39;+init=EPSG:27700&#39;</span><span class="p">)</span>
<span class="n">uk_eire_elev_BNG</span> <span class="o">&lt;-</span> <span class="nf">projectRaster</span><span class="p">(</span><span class="n">uk_eire_elev</span><span class="p">,</span> <span class="n">bng_2km</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The route data is also very detailed, which is great if you are navigating in a blizzard but does take a long time to process for this exercise. So, we’ll also simplify the route data before we use it. We’ll use a 100m tolerance for simplifying the route: it goes from 31569 points to 1512 points. You can see the difference on the two plots below and this is worth remembering: <strong>do you really need to use the highest resolution data available</strong>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simplify the data</span>
<span class="n">pennine_way_BNG_simple</span> <span class="o">&lt;-</span> <span class="nf">st_simplify</span><span class="p">(</span><span class="n">pennine_way_BNG</span><span class="p">,</span>  <span class="n">dTolerance</span><span class="o">=</span><span class="m">100</span><span class="p">)</span>

<span class="c1"># Zoom in to the whole route and plot the data</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_elev_BNG</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3e5</span><span class="p">,</span> <span class="m">5e5</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3.8e5</span><span class="p">,</span> <span class="m">6.3e5</span><span class="p">),</span>
     <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">pennine_way_BNG</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">pennine_way_BNG_simple</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;darkred&#39;</span><span class="p">)</span>

<span class="c1"># Add a zoom box and use that to create a new plot</span>
<span class="n">zoom</span> <span class="o">&lt;-</span> <span class="nf">extent</span><span class="p">(</span><span class="m">3.77e5</span><span class="p">,</span> <span class="m">3.89e5</span><span class="p">,</span> <span class="m">4.7e5</span><span class="p">,</span> <span class="m">4.85e5</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">zoom</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Zoomed in plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">uk_eire_elev_BNG</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">pennine_way_BNG</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">pennine_way_BNG_simple</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;darkred&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in plot.sf(pennine_way_BNG_simple, add = TRUE, col = &quot;darkred&quot;):
“ignoring all but the first attribute”
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in plot.sf(pennine_way_BNG_simple, add = TRUE, col = &quot;darkred&quot;):
“ignoring all but the first attribute”
</pre></div>
</div>
<img alt="../_images/practical_1_148_2.png" src="../_images/practical_1_148_2.png" />
</div>
</div>
<p>Now we can extract the elevations and cell IDs under the route. We can also simply use Pythagoras’ Theorem to find the distance between cells along the transect and hence the cumulative distance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the data</span>
<span class="n">pennine_way_trans</span> <span class="o">&lt;-</span> <span class="nf">extract</span><span class="p">(</span><span class="n">uk_eire_elev_BNG</span><span class="p">,</span> <span class="n">pennine_way_BNG_simple</span><span class="p">,</span> 
                             <span class="n">along</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">cellnumbers</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># The output is a list: in will contain one set of values for each feature in the input data</span>
<span class="nf">str</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="p">)</span>

<span class="c1"># Here, we only have one line, so we will extract it</span>
<span class="n">pennine_way_trans</span> <span class="o">&lt;-</span> <span class="n">pennine_way_trans</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span>
<span class="n">pennine_way_trans</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="p">)</span>

<span class="c1"># Get the cell coordinates </span>
<span class="n">pennine_way_xy</span> <span class="o">&lt;-</span> <span class="nf">xyFromCell</span><span class="p">(</span><span class="n">uk_eire_elev_BNG</span><span class="p">,</span> <span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">cell</span><span class="p">)</span>
<span class="n">pennine_way_trans</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="p">,</span> <span class="n">pennine_way_xy</span><span class="p">)</span>

<span class="c1"># Now we can use Pythagoras to find the distance along the transect</span>
<span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">dx</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">diff</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">x</span><span class="p">))</span>
<span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">dy</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">diff</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">y</span><span class="p">))</span>
<span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">distance_from_last</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="p">,</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">^</span><span class="m">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">^</span><span class="m">2</span><span class="p">))</span>
<span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">distance</span> <span class="o">&lt;-</span> <span class="nf">cumsum</span><span class="p">(</span><span class="n">pennine_way_trans</span><span class="o">$</span><span class="n">distance_from_last</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span> <span class="n">etopo_uk</span> <span class="o">~</span> <span class="n">distance</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pennine_way_trans</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;l&#39;</span><span class="p">,</span> 
     <span class="n">ylab</span><span class="o">=</span><span class="s">&#39;Elevation (m)&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&#39;Distance (m)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>List of 1
 $ : num [1:758, 1:2] 138457 138456 138456 138455 138455 ...
  ..- attr(*, &quot;dimnames&quot;)=List of 2
  .. ..$ : chr [1:758] &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; ...
  .. ..$ : chr [1:2] &quot;cell&quot; &quot;etopo_uk&quot;
</pre></div>
</div>
<img alt="../_images/practical_1_150_1.png" src="../_images/practical_1_150_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="mini-projects">
<h2>Mini projects<a class="headerlink" href="#mini-projects" title="Permalink to this headline">¶</a></h2>
<p>You should now have the skills to tackle the miniproject below. Give them a go - the answers are still available but try and puzzle it out.</p>
<div class="section" id="precipitation-transect-for-new-guinea">
<h3>Precipitation transect for  New Guinea<a class="headerlink" href="#precipitation-transect-for-new-guinea" title="Permalink to this headline">¶</a></h3>
<p>You have been given the following coordinates of a transect through New Guinea</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">transect_long</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">132.3</span><span class="p">,</span> <span class="m">135.2</span><span class="p">,</span> <span class="m">146.4</span><span class="p">,</span> <span class="m">149.3</span><span class="p">)</span>
<span class="n">transect_lat</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span> <span class="m">-3.9</span><span class="p">,</span> <span class="m">-7.7</span><span class="p">,</span> <span class="m">-9.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-create-a-total-annual-precipitation-transect-for-new-guinea admonition">
<p class="admonition-title">Create a total annual precipitation transect for New Guinea</p>
<ul class="simple">
<li><p>Use the 0.5 arc minute worldclim data from <code class="docutils literal notranslate"><span class="pre">getData</span></code> - you will need to specify a location to get the tile including New Guinea.</p></li>
<li><p>Use UTM 54S (<a class="reference external" href="https://epsg.io/32754">https://epsg.io/32754</a>) and use a 1 km resolution to reproject raster data. You will need to find an extent in UTM 54S to cover the study area and choose extent coordinates to create neat 1km cell boundaries</p></li>
<li><p>Create a transect with the following (WGS84 Long + Lat) coordinates:</p></li>
<li><p>You will need to reproject the transect into UTM 54S and then use the function <code class="docutils literal notranslate"><span class="pre">st_segmentize</span></code> to create regular 1000m sampling points along the transect.</p></li>
</ul>
<p>Note that some of these steps are handling a lot of data and may take a few minutes to complete.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the precipitation data</span>
<span class="n">ng_prec</span> <span class="o">&lt;-</span> <span class="nf">getData</span><span class="p">(</span><span class="s">&#39;worldclim&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s">&#39;prec&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="m">140</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="m">-10</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
<span class="c1"># Reduce to the extent of New Guinea - crop early to avoid unnecessary processing!</span>
<span class="n">ng_extent</span> <span class="o">&lt;-</span> <span class="nf">extent</span><span class="p">(</span><span class="m">130</span><span class="p">,</span> <span class="m">150</span><span class="p">,</span> <span class="m">-10</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
<span class="n">ng_prec</span> <span class="o">&lt;-</span> <span class="nf">crop</span><span class="p">(</span><span class="n">ng_prec</span><span class="p">,</span> <span class="n">ng_extent</span><span class="p">)</span>
<span class="c1"># Calculate annual precipitation</span>
<span class="n">ng_annual_prec</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">ng_prec</span><span class="p">)</span>

<span class="c1"># Now reproject to UTM 54S. The code here is using reprojecting the extent of the</span>
<span class="c1"># raster data to get sensible values for the UTM 54S extent. We are picking extent </span>
<span class="c1"># values here that create a neat 1000m grid with sensible cell edges</span>
<span class="n">ng_extent_poly</span> <span class="o">&lt;-</span> <span class="nf">st_as_sfc</span><span class="p">(</span><span class="nf">st_bbox</span><span class="p">(</span><span class="n">ng_extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">))</span>
<span class="nf">st_transform</span><span class="p">(</span><span class="n">ng_extent_poly</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">32754</span><span class="p">)</span>
<span class="n">ng_extent_utm</span> <span class="o">&lt;-</span> <span class="nf">extent</span><span class="p">(</span><span class="m">-732000</span><span class="p">,</span> <span class="m">1506000</span><span class="p">,</span> <span class="m">8874000</span><span class="p">,</span> <span class="m">10000000</span><span class="p">)</span>

<span class="c1"># Create the raster and reproject the data</span>
<span class="n">ng_template_utm</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">ng_extent_utm</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&quot;+init=EPSG:32754&quot;</span><span class="p">)</span>
<span class="n">ng_annual_prec_utm</span> <span class="o">&lt;-</span> <span class="nf">projectRaster</span><span class="p">(</span><span class="n">ng_annual_prec</span><span class="p">,</span> <span class="n">ng_template_utm</span><span class="p">)</span>

<span class="c1"># Create and reproject the transect and then segmentize it to 1000m</span>
<span class="n">transect</span> <span class="o">&lt;-</span>  <span class="nf">st_linestring</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">transect_long</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">transect_lat</span><span class="p">))</span>
<span class="n">transect</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">transect</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="n">transect_utm</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">transect</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">32754</span><span class="p">)</span>
<span class="n">transect_utm</span> <span class="o">&lt;-</span> <span class="nf">st_segmentize</span><span class="p">(</span><span class="n">transect_utm</span><span class="p">,</span> <span class="n">dfMaxLength</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>

<span class="n">transect_data</span> <span class="o">&lt;-</span> <span class="nf">extract</span><span class="p">(</span><span class="n">ng_annual_prec_utm</span><span class="p">,</span> <span class="nf">as</span><span class="p">(</span><span class="n">transect_utm</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> 
                             <span class="n">along</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">cellnumbers</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Get the first item from the transect data </span>
<span class="n">transect_data</span> <span class="o">&lt;-</span> <span class="n">transect_data</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span>
<span class="n">transect_data</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">transect_data</span><span class="p">)</span>

<span class="c1"># Get the cell coordinates </span>
<span class="n">transect_data_xy</span> <span class="o">&lt;-</span> <span class="nf">xyFromCell</span><span class="p">(</span><span class="n">ng_annual_prec_utm</span><span class="p">,</span> <span class="n">transect_data</span><span class="o">$</span><span class="n">cell</span><span class="p">)</span>
<span class="n">transect_data</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">transect_data</span><span class="p">,</span> <span class="n">transect_data_xy</span><span class="p">)</span>

<span class="c1"># Now we can use Pythagoras to find the distance along the transect</span>
<span class="n">transect_data</span><span class="o">$</span><span class="n">dx</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">diff</span><span class="p">(</span><span class="n">transect_data</span><span class="o">$</span><span class="n">x</span><span class="p">))</span>
<span class="n">transect_data</span><span class="o">$</span><span class="n">dy</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">diff</span><span class="p">(</span><span class="n">transect_data</span><span class="o">$</span><span class="n">y</span><span class="p">))</span>
<span class="n">transect_data</span><span class="o">$</span><span class="n">distance_from_last</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">transect_data</span><span class="p">,</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">^</span><span class="m">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">^</span><span class="m">2</span><span class="p">))</span>
<span class="n">transect_data</span><span class="o">$</span><span class="n">distance</span> <span class="o">&lt;-</span> <span class="nf">cumsum</span><span class="p">(</span><span class="n">transect_data</span><span class="o">$</span><span class="n">distance_from_last</span><span class="p">)</span>

<span class="c1"># Get the natural earth high resolution coastline.</span>
<span class="n">ne_10_ng</span>  <span class="o">&lt;-</span> <span class="nf">st_crop</span><span class="p">(</span><span class="n">ne_10</span><span class="p">,</span> <span class="n">ng_extent_poly</span><span class="p">)</span>
<span class="n">ne_10_ng_utm</span> <span class="o">&lt;-</span>  <span class="nf">st_transform</span><span class="p">(</span><span class="n">ne_10_ng</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="m">32754</span><span class="p">)</span>

<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mgp</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ng_annual_prec_utm</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">ne_10_ng_utm</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">NA</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s">&#39;grey50&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">transect_utm</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span> <span class="n">layer</span> <span class="o">~</span> <span class="n">distance</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">transect_data</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;l&#39;</span><span class="p">,</span> 
     <span class="n">ylab</span><span class="o">=</span><span class="s">&#39;Annual precipitation (mm)&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&#39;Distance (m)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLYGON ((-712615.3 8874187, 1490218 8880999, 1...
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geometry set for 1 feature 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -731666 ymin: 8874187 xmax: 1505647 ymax: 1e+07
CRS:           EPSG:32754
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>although coordinates are longitude/latitude, st_intersection assumes that they are planar
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in plot.sf(ne_10_ng_utm, add = TRUE, col = NA, border = &quot;grey50&quot;):
“ignoring all but the first attribute”
</pre></div>
</div>
<img alt="../_images/practical_1_154_4.png" src="../_images/practical_1_154_4.png" />
</div>
</div>
</div>
<div class="section" id="fishing-pressure-in-fiji">
<h3>Fishing pressure in Fiji<a class="headerlink" href="#fishing-pressure-in-fiji" title="Permalink to this headline">¶</a></h3>
<p>This exercise is quite a bit harder - you will probably need to read more help files (or peek at the code) but see how you go!</p>
<p>Researchers have identified 7 commonly used fishing sites around the island of Kadavu in Fiji. The have also conducted surveys of the coastal villages known to use these sites and are trying to identify how many households are likely to use site. We are going to use the simplifying assumption that each village will <em>always</em> use the closest site.</p>
<p>We can’t just use <code class="docutils literal notranslate"><span class="pre">st_distance</span></code> because we need the distances to reflect travel distances through the sea rather than straight line distances. So we are going to need to use a new tool: <strong>cost distance analysis</strong>. Cost distance models use a raster to define a cost surface: moving from a cell to a neighbouring cell has a cost which is derived from the values in the raster. This gives us a way to ask what the cost of getting from A to B is, where movement is allowed to avoid areas that are expensive to traverse.</p>
<p>We’re also going to be using some data in an Excel file. It is really common to use Excel to arrange and manage data tables. If you use R you then typically end up exporting CSVs to load, but there is a better way: read the data directly from Excel. This means that you don’t have to maintain multiple versions of the same data in different formats.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;gdistance&#39;</span><span class="p">)</span> <span class="c1"># Cost distance analysis</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#39;openxlsx&#39;</span><span class="p">)</span> <span class="c1"># Load data from Excel directly</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">gdistance</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">openxlsx</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: igraph
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: ‘igraph’
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following object is masked from ‘package:raster’:

    union
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following objects are masked from ‘package:stats’:

    decompose, spectrum
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following object is masked from ‘package:base’:

    union
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: Matrix
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: ‘gdistance’
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following object is masked from ‘package:igraph’:

    normalize
</pre></div>
</div>
</div>
</div>
<div class="section" id="loading-the-data">
<h4>Loading the data<a class="headerlink" href="#loading-the-data" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">getData</span></code> to obtain the GADM Level 2 vector data for Fiji (<code class="docutils literal notranslate"><span class="pre">country='FJI'</span></code>) and then extract Kadavu.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">readWorbook</span></code> to load the data from each of the <code class="docutils literal notranslate"><span class="pre">Villages</span></code> and <code class="docutils literal notranslate"><span class="pre">Field</span> <span class="pre">sites</span></code> worksheets from the <code class="docutils literal notranslate"><span class="pre">FishingPressure.xlsx</span></code> spreadsheet and convert those tables into  <code class="docutils literal notranslate"><span class="pre">sf</span></code>  objects with POINT data.</p></li>
<li><p>All of those data are in WGS84 coordinates, so convert them to a projection system appropriate to Fiji (UTM 60S: EPSG:32760).</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download the GADM data for Fiji, convert to sf and then extract Kadavu</span>
<span class="n">fiji</span> <span class="o">&lt;-</span> <span class="nf">getData</span><span class="p">(</span><span class="s">&#39;GADM&#39;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s">&#39;FJI&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
<span class="n">fiji</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">fiji</span><span class="p">)</span>
<span class="n">kadavu</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">fiji</span><span class="p">,</span> <span class="n">NAME_2</span> <span class="o">==</span> <span class="s">&#39;Kadavu&#39;</span><span class="p">)</span>

<span class="c1"># Load the villages and sites and convert to sf</span>
<span class="n">villages</span> <span class="o">&lt;-</span> <span class="nf">readWorkbook</span><span class="p">(</span><span class="s">&#39;data/FishingPressure.xlsx&#39;</span><span class="p">,</span> <span class="s">&#39;Villages&#39;</span><span class="p">)</span>
<span class="n">villages</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">villages</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;long&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">&lt;-</span> <span class="nf">readWorkbook</span><span class="p">(</span><span class="s">&#39;data/FishingPressure.xlsx&#39;</span><span class="p">,</span> <span class="s">&#39;Field sites&#39;</span><span class="p">,</span> <span class="n">startRow</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;Long&#39;</span><span class="p">,</span><span class="s">&#39;Lat&#39;</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="m">4326</span><span class="p">)</span>

<span class="c1"># Reproject the data UTM60S</span>
<span class="n">kadavu</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">kadavu</span><span class="p">,</span> <span class="m">32760</span><span class="p">)</span>
<span class="n">villages</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">villages</span><span class="p">,</span> <span class="m">32760</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="m">32760</span><span class="p">)</span>

<span class="c1"># Map to check everything look right.</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">villages</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">kadavu</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_158_0.png" src="../_images/practical_1_158_0.png" />
</div>
</div>
</div>
<div class="section" id="create-the-cost-surface">
<h4>Create the cost surface<a class="headerlink" href="#create-the-cost-surface" title="Permalink to this headline">¶</a></h4>
<p>The cost surface should assign a uniform cost to moving through the sea and an infinite cost (<code class="docutils literal notranslate"><span class="pre">NA</span></code>) to moving over land. The resolution of your cost surface raster matters: a very fine resolution will give very precise distances but take a long time to run;  a coarse resolution will run quickly but the distances will be very crude. So, you need to:</p>
<ul class="simple">
<li><p>pick extents to cover the islands and sites.,</p></li>
<li><p>pick a resolution,</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">st_rasterize</span></code> to convert the vector coastline into a raster and create the surface.</p></li>
</ul>
<p>Remember from above the difference between rasterizing a polygon and a linestring: cells containing coastline contain sea so should be available for movement.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a template raster covering the whole study area, at a given resolution</span>
<span class="n">res</span> <span class="o">&lt;-</span> <span class="m">100</span>
<span class="n">r</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">xmn</span><span class="o">=</span><span class="m">590000</span><span class="p">,</span> <span class="n">xmx</span><span class="o">=</span><span class="m">670000</span><span class="p">,</span> <span class="n">ymn</span><span class="o">=</span><span class="m">7870000</span><span class="p">,</span> <span class="n">ymx</span><span class="o">=</span><span class="m">7940000</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s">&#39;+init=EPSG:32760&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>

<span class="c1"># Rasterize the island as a POLYGON to get cells that cannot be traversed</span>
<span class="n">kadavu_poly</span> <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">kadavu</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> 
                         <span class="n">field</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
<span class="c1"># Rasterize the island as a MULTILINESTRING to get the coastal </span>
<span class="c1"># cells that _can_ be traversed</span>
<span class="n">kadavu_lines</span> <span class="o">&lt;-</span> <span class="nf">rasterize</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="nf">st_cast</span><span class="p">(</span><span class="n">kadavu</span><span class="p">,</span> <span class="s">&#39;MULTILINESTRING&#39;</span><span class="p">),</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> 
                         <span class="n">field</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>

<span class="c1"># Combine those to give cells that are in the sea (kadavu_poly=0) or in the coast (kadavu_lines=1)</span>
<span class="n">sea_r</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="o">!</span> <span class="n">kadavu_poly</span><span class="p">)</span> <span class="o">|</span> <span class="n">kadavu_lines</span>

<span class="c1"># Set the costs</span>
<span class="n">sea_r</span><span class="p">[</span><span class="n">sea_r</span> <span class="o">==</span> <span class="m">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">NA</span>
<span class="n">sea_r</span><span class="p">[</span><span class="o">!</span> <span class="nf">is.na</span><span class="p">(</span><span class="n">sea_r</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="m">1</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">sea_r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_160_0.png" src="../_images/practical_1_160_0.png" />
</div>
</div>
</div>
<div class="section" id="finding-launch-points">
<h4>Finding launch points<a class="headerlink" href="#finding-launch-points" title="Permalink to this headline">¶</a></h4>
<p>The villages are not all on the coast! If the village is too far inland then it may sit in a cell with an infinite travel cost. So we need to find the closest point on the coast to each village using <code class="docutils literal notranslate"><span class="pre">st_nearest_points</span></code>. All points within a polygon are part of that polygon, so we have to explicitly convert the island polygon to a MULTILINESTRING showing the coast to find point on the coast.</p>
<p>The output of <code class="docutils literal notranslate"><span class="pre">st_nearest_points</span></code> is a line that joins each village point to the nearest point on the coast. The second points on each of these lines are our nearest launch points and we can use <code class="docutils literal notranslate"><span class="pre">st_line_sample</span></code> with <code class="docutils literal notranslate"><span class="pre">sample=1</span></code> to extract them.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the nearest points on the coast to each village</span>
<span class="n">village_coast</span> <span class="o">&lt;-</span> <span class="nf">st_nearest_points</span><span class="p">(</span><span class="n">villages</span><span class="p">,</span> <span class="nf">st_cast</span><span class="p">(</span><span class="n">kadavu</span><span class="p">,</span> <span class="s">&#39;MULTILINESTRING&#39;</span><span class="p">))</span>
<span class="c1"># Extract the end point on the coast and convert from MULTIPOINT to POINT</span>
<span class="n">launch_points</span> <span class="o">&lt;-</span> <span class="nf">st_line_sample</span><span class="p">(</span><span class="n">village_coast</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="n">launch_points</span> <span class="o">&lt;-</span> <span class="nf">st_cast</span><span class="p">(</span><span class="n">launch_points</span><span class="p">,</span> <span class="s">&#39;POINT&#39;</span><span class="p">)</span>

<span class="c1"># Zoom in to a bay on Kadavu</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">kadavu</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">616000</span><span class="p">,</span> <span class="m">618000</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">7889000</span><span class="p">,</span> <span class="m">7891000</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;khaki&#39;</span><span class="p">)</span>
 <span class="c1"># Plot the villages, lines to the nearest coast and the launch points.</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">villages</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;firebrick&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">village_coast</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">launch_points</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;darkgreen&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_162_0.png" src="../_images/practical_1_162_0.png" />
</div>
</div>
<p>We can add the launch points in to our <code class="docutils literal notranslate"><span class="pre">villages</span></code> object. It is possible to have more than one geometry associated with a row of data: you just have to set which one is being used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">villages</span><span class="o">$</span><span class="n">launch_points</span> <span class="o">&lt;-</span> <span class="n">launch_points</span>
<span class="nf">st_geometry</span><span class="p">(</span><span class="n">villages</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s">&#39;launch_points&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="find-distances">
<h4>Find distances<a class="headerlink" href="#find-distances" title="Permalink to this headline">¶</a></h4>
<p>This is a really hard bit because the way the <code class="docutils literal notranslate"><span class="pre">costDistance</span></code> function work is quite complex. The first step is to use <code class="docutils literal notranslate"><span class="pre">transition</span></code> to create a transition graph. This sets:</p>
<ol class="simple">
<li><p>Which cells are connected to each other: common options are <code class="docutils literal notranslate"><span class="pre">directions=4</span></code> (rook’s move), <code class="docutils literal notranslate"><span class="pre">directions=8</span></code> (queen’s move) and <code class="docutils literal notranslate"><span class="pre">directions=16</span></code> (knight’s move).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">5</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="m">5</span><span class="p">))</span>
<span class="n">r</span><span class="p">[</span><span class="m">13</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">2</span>
<span class="c1"># rook, queen and knight cells from the centre cell (13)</span>
<span class="c1"># - the output is a matrix with the second column showing the neighbours</span>
<span class="n">rook</span> <span class="o">&lt;-</span> <span class="nf">adjacent</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="m">4</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">adjacent</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="m">8</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span>
<span class="n">knight</span> <span class="o">&lt;-</span> <span class="nf">adjacent</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="m">16</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span>
<span class="c1"># plot those</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="n">r</span><span class="p">[</span><span class="n">rook</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">r</span><span class="p">[</span><span class="n">queen</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">r</span><span class="p">[</span><span class="n">knight</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_166_0.png" src="../_images/practical_1_166_0.png" />
</div>
</div>
<ol class="simple">
<li><p>What the cost of moving between connected cells are by applying a function to the values in the two connected cells.</p></li>
</ol>
<p>However, <code class="docutils literal notranslate"><span class="pre">transition</span></code> just creates the network and assigns the basic transition values between cells. In a GIS setting, we also need to scale the costs by the physical distances between cells, using <code class="docutils literal notranslate"><span class="pre">geoCorrection</span></code>. We can then use <code class="docutils literal notranslate"><span class="pre">costDistance</span></code> to find the distances between sites and launch points through the transition network.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tr</span> <span class="o">&lt;-</span> <span class="nf">transition</span><span class="p">(</span><span class="n">sea_r</span><span class="p">,</span> <span class="n">transitionFunction</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="m">8</span><span class="p">)</span>
<span class="n">tr</span> <span class="o">&lt;-</span> <span class="nf">geoCorrection</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

<span class="c1"># Now we can calculate the cost distance for each launch point to each site</span>
<span class="n">costs</span> <span class="o">&lt;-</span> <span class="nf">costDistance</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="nf">as</span><span class="p">(</span><span class="n">villages</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">),</span> <span class="nf">as</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="s">&#39;Spatial&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="assign-villages-to-sites">
<h4>Assign villages to sites<a class="headerlink" href="#assign-villages-to-sites" title="Permalink to this headline">¶</a></h4>
<p>The result of <code class="docutils literal notranslate"><span class="pre">costDistance</span></code> is a matrix showing the calculated distance through the sea from each launch point to each site. All we need to do now is find the nearest site to each village, count up households per site and merge that information into the sites.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the index and name of the lowest distance in each row</span>
<span class="n">villages</span><span class="o">$</span><span class="n">nearest_site_index</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">which.min</span><span class="p">)</span>
<span class="n">villages</span><span class="o">$</span><span class="n">nearest_site_name</span>  <span class="o">&lt;-</span> <span class="n">sites</span><span class="o">$</span><span class="n">Name</span><span class="p">[</span><span class="n">villages</span><span class="o">$</span><span class="n">nearest_site_index</span><span class="p">]</span>

<span class="c1"># Find the total number of buildings  per site and merge that data</span>
<span class="c1"># into the sites object</span>
<span class="n">site_load</span> <span class="o">&lt;-</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">building_count</span> <span class="o">~</span> <span class="n">nearest_site_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">villages</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="n">sum</span><span class="p">)</span>
<span class="n">sites</span> <span class="o">&lt;-</span> <span class="nf">merge</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">site_load</span><span class="p">,</span> <span class="n">by.x</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">by.y</span><span class="o">=</span><span class="s">&#39;nearest_site_name&#39;</span><span class="p">,</span> <span class="n">all.x</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Now build up a complex plot</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">kadavu</span><span class="p">))</span>
<span class="c1"># add the villages, colouring by nearest site and showing the village </span>
<span class="c1"># size using the symbol size (cex)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">villages</span><span class="p">[</span><span class="s">&#39;nearest_site_name&#39;</span><span class="p">],</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>  <span class="n">cex</span><span class="o">=</span><span class="nf">log10</span><span class="p">(</span><span class="n">villages</span><span class="o">$</span><span class="n">building_count</span><span class="p">))</span>
<span class="c1"># Add the sites and label with site name and building count</span>
<span class="nf">plot</span><span class="p">(</span><span class="nf">st_geometry</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="nf">sprintf</span><span class="p">(</span><span class="s">&#39;%s: %s&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">building_count</span><span class="p">))</span>
<span class="nf">text</span><span class="p">(</span><span class="nf">st_coordinates</span><span class="p">(</span><span class="n">sites</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>

<span class="c1"># Add the path for each village to its nearest site</span>
<span class="nf">for</span><span class="p">(</span><span class="n">idx</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">villages</span><span class="p">))){</span>
	<span class="n">this_village</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">villages</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">],</span> <span class="s">&#39;Spatial&#39;</span><span class="p">)</span>
	<span class="n">this_village_site</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">this_village</span><span class="o">$</span><span class="n">nearest_site_index</span><span class="p">,</span> <span class="p">],</span> <span class="s">&#39;Spatial&#39;</span><span class="p">)</span>
	<span class="n">journey</span> <span class="o">&lt;-</span> <span class="nf">shortestPath</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">this_village</span><span class="p">,</span> <span class="n">this_village_site</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">&#39;SpatialLines&#39;</span><span class="p">)</span>
	<span class="nf">plot</span><span class="p">(</span><span class="nf">st_as_sfc</span><span class="p">(</span><span class="n">journey</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_170_0.png" src="../_images/practical_1_170_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="using-ggplot-to-make-maps">
<h2>Using ggplot to make maps<a class="headerlink" href="#using-ggplot-to-make-maps" title="Permalink to this headline">¶</a></h2>
<p>As you will have seen in the last couple of weeks, <code class="docutils literal notranslate"><span class="pre">ggplot</span></code> is a popular package for plotting and can be used for with <code class="docutils literal notranslate"><span class="pre">sf</span></code> objects in maps too. There is also a package called <code class="docutils literal notranslate"><span class="pre">tmap</span></code> which works in a very similar way to <code class="docutils literal notranslate"><span class="pre">ggplot</span></code> but is more tightly focussed on map plotting. If you end up creating lots of maps, that might be a good place to look.  Essentially GIS maps are mostly about deciding what information you want to show and the plot order, so the simple plotting we use here can be pretty good without needing extra tools.</p>
<p>Having said that, here is a <code class="docutils literal notranslate"><span class="pre">ggplot</span></code> map of the world.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">ne_110</span><span class="p">)</span> <span class="o">+</span>
       <span class="nf">geom_sf</span><span class="p">()</span> <span class="o">+</span>
       <span class="nf">theme_bw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_172_0.png" src="../_images/practical_1_172_0.png" />
</div>
</div>
<p>There are several <code class="docutils literal notranslate"><span class="pre">ggplot</span></code> extensions for <code class="docutils literal notranslate"><span class="pre">sf</span></code> that make it easier to colour and label your <code class="docutils literal notranslate"><span class="pre">ggplot</span></code> maps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">europe</span> <span class="o">&lt;-</span> <span class="nf">st_crop</span><span class="p">(</span><span class="n">ne_110</span><span class="p">,</span> <span class="nf">extent</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span><span class="m">40</span><span class="p">,</span><span class="m">35</span><span class="p">,</span><span class="m">75</span><span class="p">))</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">europe</span><span class="p">)</span> <span class="o">+</span>
       <span class="nf">geom_sf</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="nf">log</span><span class="p">(</span><span class="n">GDP_MD_EST</span><span class="p">)))</span> <span class="o">+</span>
       <span class="nf">scale_fill_viridis_c</span><span class="p">()</span> <span class="o">+</span>
       <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
       <span class="nf">geom_sf_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">ADMIN</span><span class="p">),</span> <span class="n">pointsize</span><span class="o">=</span><span class="m">9</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="s">&quot;grey20&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>although coordinates are longitude/latitude, st_intersection assumes that they are planar
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
“attribute variables are assumed to be spatially constant throughout all geometries”
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
“Ignoring unknown parameters: pointsize”
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in st_point_on_surface.sfc(sf::st_zm(x)):
“st_point_on_surface may not give correct results for longitude/latitude data”
</pre></div>
</div>
<img alt="../_images/practical_1_174_4.png" src="../_images/practical_1_174_4.png" />
</div>
</div>
<div class="admonition-european-life-expectancy admonition">
<p class="admonition-title">European life expectancy</p>
<p>Can you update the code above to create the map below of European life expectancy. Note that the map is now in a projected coordinate system: <a class="reference external" href="http://epsg.io/3035">ETRS89 / LAEA Europe</a> (EPSG: 3035).</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">europe_laea</span> <span class="o">&lt;-</span> <span class="nf">st_transform</span><span class="p">(</span><span class="n">europe</span><span class="p">,</span> <span class="m">3035</span><span class="p">)</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">europe_laea</span><span class="p">)</span> <span class="o">+</span>
       <span class="nf">geom_sf</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">Numeric</span><span class="p">))</span> <span class="o">+</span>
       <span class="nf">scale_fill_viridis_c</span><span class="p">()</span> <span class="o">+</span>
       <span class="nf">theme_bw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_176_0.png" src="../_images/practical_1_176_0.png" />
</div>
</div>
<p>What is wrong with that map? Can you fix it?</p>
</div>
<div class="section" id="colour-palettes">
<h2>Colour palettes<a class="headerlink" href="#colour-palettes" title="Permalink to this headline">¶</a></h2>
<p>Colour palettes are an essential part of presenting spatial data, as often we
read the data as a colour scale on a map, rather than an x- or y-axis of
continuous variables. There has been a lot of discussion amongst researches on
the best colour scales to use. Rainbow colours used to be a the most common
used, but are not appropriate for colour blindness and interpreting the data
can be hard. Rainbow can be found amongst the R base colours, but I would not
recommend using them as there are plenty more better options.</p>
<p><img alt="R base colour palettes." src="../_images/rbase.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">hcl.colors</span></code> function - as used above - is a far better choice in many cases. There are a wide range of palettes (see <code class="docutils literal notranslate"><span class="pre">hcl.pals()</span></code>) with different use cases. There are also some specific packages that provide extra colour schemes.</p>
<div class="section" id="viridis">
<h3>Viridis<a class="headerlink" href="#viridis" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">viridis</span></code> package contains the <code class="docutils literal notranslate"><span class="pre">viridis</span></code> palette, but also these other palettes:</p>
<p><img alt="Colour palettes from the viridis package." src="../_images/viridis.png" /></p>
<p>Re-plot the life expectancy map of Europe using each of the other 3 palettes in
the <code class="docutils literal notranslate"><span class="pre">viridis</span></code> pacakge. Which one do you prefer?</p>
<p>With <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>, you can use the functions <code class="docutils literal notranslate"><span class="pre">scale_color_viridis()</span></code> to colour points, lines or
texts and <code class="docutils literal notranslate"><span class="pre">scale_fill_viridis()</span></code> to fill areas. Use the <code class="docutils literal notranslate"><span class="pre">option</span></code> argument to
select which pallette in <code class="docutils literal notranslate"><span class="pre">viridis</span></code> you wish, with the viridis palette being the
default.</p>
</div>
<div class="section" id="brewer">
<h3>Brewer<a class="headerlink" href="#brewer" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span>
<span class="nf">display.brewer.all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_178_0.png" src="../_images/practical_1_178_0.png" />
</div>
</div>
<p>The first group are spectral palettes that are most similar to <code class="docutils literal notranslate"><span class="pre">viridis</span></code> and
good for representing continous data. The second group are qualitative palettes
which should be used for categorical data (e.g. bar plots) and the final group
put equal emphasis on the mid-range values as well as those at the end. These
should be used when representing changes a value, e.g. temperature, where the
white middle colour shows no change has occurred in the data.</p>
<p>The brewer packages has a neat way of showing colours that are
colourblind-friendly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">display.brewer.all</span><span class="p">(</span><span class="n">colorblindFriendly</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_1_180_0.png" src="../_images/practical_1_180_0.png" />
</div>
</div>
<p>As with <code class="docutils literal notranslate"><span class="pre">viridis</span></code> you can use <code class="docutils literal notranslate"><span class="pre">scale_color_brewer()</span></code> and <code class="docutils literal notranslate"><span class="pre">scale_fill_brewer()</span></code>
in <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>.</p>
<!-- ## Extensions

### GIF of WHO data
Make a GIF which mapping the time series of the global life expectancy for all countries from 2000 to 2016. Hint use the `tmap` package and `tmap_animation()`. See the 'Geocomputation in R' book for more information. --></div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./practical_1"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../intro.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Introduction to the practicals</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../practical_2/practical_2.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Practical Two: Species Distribution Modelling</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By David Orme<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>